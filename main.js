import { TUNINGS, SCALES } from './database.js';
// --- CONSTANTS ---
const FRET_SPACING = 75; // Standard width for each fret segment in the GUI (in px)
const STRING_PITCH_GAP = 40; // Vertical gap between strings (in px)
const NUM_FRETS = 15; // Use a global fret count

// --- DATA DEFINITIONS ---

const CHROMATIC_NOTES = [
    { name: "C", aliases: [] },
    { name: "C♯", aliases: ["D♭"] },
    { name: "D", aliases: [] },
    { name: "D♯", aliases: ["E♭"] },
    { name: "E", aliases: [] },
    { name: "F", aliases: [] },
    { name: "F♯", aliases: ["G♭"] },
    { name: "G", aliases: [] },
    { name: "G♯", aliases: ["A♭"] },
    { name: "A", aliases: [] },
    { name: "A♯", aliases: ["B♭"] },
    { name: "B", aliases: [] }
];

// --- SECTION 1: CORRECTED CONSTANTS (from C_Major_Guitar_Tab_sequential.csv) ---

const NOTES_PER_BEAT = 4; // 16th notes
const DEFAULT_BEATS_PER_MEASURE = 4; // 4/4 time
const DEFAULT_NOTES_PER_MEASURE = DEFAULT_BEATS_PER_MEASURE * NOTES_PER_BEAT; // 16

// --- FIX: Updated totals based on the full CSV data (C_Major_Guitar_Tab_sequential.csv) ---
const TOTAL_MEASURES = 32;
const TOTAL_DEFAULT_NOTES = 512;
// --- END SECTION 1 ---


// --- SECTION 2: CORRECTED C_MAJOR_BASE_TAB (from C_Major_Guitar_Tab_sequential.csv) ---
// This 6-string guitar tab is left as-is, per user request.
const C_MAJOR_BASE_TAB = {
    'e4': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M6
        '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','10','12', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '0','-','-','-','-','1','3','-','-','-','-','0','1','-','-','3', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '-','-','3','2','-','-','-','-','1','0','-','-','-','-','-','-', // M17
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M18
        '-','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M19
        '2','2','-','-','4','4','-','-','1','1','-','-','4','-','-','-', // M20
        '-','-','-','-','4','-','4','-','2','-','2','-','-','-','-','0', // M21
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M22
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','4', // M23
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','0', // M24
        '3','1','0','-','-','-','-','-','-','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','5', // M26
        '8','7','5','-','-','-','-','-','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','-','-','-','-','-','-','10','12','13', // M28
        '13','12','10','-','-','-','-','-','-','-','-','-','-','-','-','-', // M29
        '-','-','-','-','-','-','-','-','-','-','3','1','-','2','-','-', // M30
        '-','-','2','-','1','3','-','-','-','-','-','-','-','-','-','-', // M31
        '12','10','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M32
    ],
    'B3': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','-','-','-','8','10','-','-', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '-','1','-','-','3','-','-','0','-','-','3','-','-','3','1','-', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '-','1','-','-','3','-','-','0','-','-','3','-','-','3','1','-', // M17
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M18
        '2','2','-','-','4','4','-','-','1','1','-','-','2','-','-','-', // M19
        '3','-','3','-','5','-','5','-','1','-','1','-','-','5','3','-', // M20
        '1','-','1','-','5','-','-','5','3','-','-','3','-','-','3','3', // M21
        '-','-','-','-','-','-','-','-','1','-','1','-','-','-','-','3', // M22
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','4','4', // M23
        '-','-','-','-','-','-','-','-','-','-','-','-','0','1','3','-', // M24
        '-','-','-','3','1','0','-','-','-','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','-','-','-','5','6','8','-', // M26
        '-','-','-','8','6','5','-','-','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','-','-','-','10','12','13','-','-','-', // M28
        '-','-','-','13','12','10','-','-','-','-','-','-','-','-','-','-', // M29
        '-','-','10','8','6','5','6','5','4','2','3','1','-','3','1','-', // M30
        '-','1','3','-','1','3','2','4','5','6','5','6','8','10','-','-', // M31
        '-','-','10','8','-','-','-','-','-','-','-','-','-','-','-','-', // M32
    ],
    'G3': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '0','2','0','4','2','4','2','0','4','0','2','0','4','0','4','2', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '4','2','4','0','2','0','2','4','2','4','2','0','2','4','2','4', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','5','7','9','-','-','-','-', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '-','-','4','2','-','-','-','-','2','0','-','-','-','-','-','-', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '0','-','-','-','-','1','3','-','-','-','-','0','2','-','-','4', // M17
        '1','1','-','-','2','2','-','-','0','0','-','-','-','-','-','-', // M18
        '2','-','2','-','4','-','4','-','0','-','0','-','-','2','4','-', // M19
        '2','-','-','2','4','-','-','4','2','-','-','2','-','-','-','2', // M20
        '2','-','-','2','4','4','-','-','2','2','-','-','-','2','-','2', // M21
        '0','-','0','-','4','-','4','-','0','-','-','0','-','-','2','2', // M22
        '-','-','-','-','-','-','-','-','1','-','1','-','-','2','-','2', // M23
        '-','-','-','-','-','-','-','-','-','0','2','4','-','-','-','-', // M24
        '-','-','-','-','-','-','4','2','0','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','5','7','9','-','-','-','-', // M26
        '-','-','-','-','-','-','7','5','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','9','10','12','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','12','10','9','-','-','-','-','-','-','-', // M29
        '10','9','9','7','5','4','5','4','3','2','0','2','1','2','0','3', // M30
        '3','0','2','1','2','0','2','3','4','5','4','5','7','9','9','10', // M31
        '-','-','-','-','9','7','5','-','-','-','-','-','-','-','-','-', // M32
    ],
    'D3': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '0','2','0','3','2','3','2','0','3','0','2','0','3','0','3','2', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '3','2','3','0','2','0','2','3','2','3','2','0','2','3','2','3', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','3','5','7','-','-','-','-','-','-','-', // M13
        '-','-','3','2','-','-','-','-','2','0','-','-','-','-','-','-', // M14
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
        '0','-','-','-','-','2','3','-','-','-','-','0','2','-','-','3', // M16
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
        '2','-','2','-','3','-','3','-','0','-','0','-','2','-','-','-', // M18
        '2','-','-','2','4','-','-','4','2','-','-','2','-','-','-','4', // M19
        '0','-','-','-','2','-','-','-','3','-','-','-','-','-','-','-', // M20
        '3','3','-','-','-','-','-','-','-','-','-','-','3','-','-','3', // M21
        '2','-','-','2','4','-','-','4','2','2','-','-','-','2','-','2', // M22
        '2','-','2','-','3','-','3','-','0','-','-','0','2','-','-','2', // M23
        '-','-','-','-','-','-','0','2','3','-','-','-','-','-','-','-', // M24
        '-','-','-','-','-','-','-','-','-','-','-','-','3','2','0','-', // M25
        '-','-','-','-','-','-','5','7','9','-','-','-','-','-','-','-', // M26
        '-','-','-','-','-','-','-','-','7','5','-','-','-','-','-','-', // M27
        '-','-','-','-','9','10','12','-','-','-','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','-','-','-','12','10','9','-','-','-','-', // M29
        '10','9','7','5','7','6','7','5','4','2','0','3','2','0','2','4', // M30
        '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
        '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
    ],
    'A2': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '0','2','0','3','2','3','2','0','3','0','2','0','3','0','3','2', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '3','2','3','0','2','0','2','3','2','3','2','0','2','3','2','3', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','2','3','5','-','-','-','-','-','-','-','-','-','-', // M13
        '-','2','-','-','3','-','-','0','-','-','3','-','-','3','2','-', // M14
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
        '-','2','-','-','3','-','-','0','-','-','3','-','-','3','2','-', // M16
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
        '2','-','-','2','3','-','-','3','2','-','-','2','-','3','2','-', // M18
        '0','-','-','-','2','-','-','-','3','-','-','-','-','-','-','-', // M19
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M20
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','0', // M21
        '3','3','-','-','2','2','-','-','-','-','-','-','3','-','-','3', // M22
        '3','-','-','3','3','-','-','3','2','2','-','-','-','-','-','-', // M23
        '-','-','-','0','2','3','-','-','-','-','-','-','-','-','-','-', // M24
        '-','-','-','-','-','-','-','-','-','-','-','-','3','2','0','-', // M25
        '-','-','-','-','-','-','5','7','8','-','-','-','-','-','-','-', // M26
        '-','-','-','-','-','-','-','-','-','-','8','7','5','-','-','-', // M27
        '-','-','10','12','-','-','-','-','-','-','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','-','-','-','-','-','-','12','10','-','-', // M29
        '12','11','8','6','8','7','5','3','2','0','-','-','2','-','3','4', // M30
        '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
        '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
    ],
    'E2': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M18
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M19
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M20
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M21
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M22
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M23
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M24
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M26
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M29
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M30
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M31
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M32
    ],
};
// --- END SECTION 2 ---


// --- SECTION 3: C_MAJOR_BASE_NOTE_MAP (6-String Guitar) ---
// This map is left as-is, per user request.
const C_MAJOR_BASE_NOTE_MAP = {
    'e4': { '0': 4, '1': 5, '2': 6, '3': 7, '4': 8, '5': 9, '7': 11, '8': 12, '10': 14, '12': 16, '13': 17 },
    'B3': { '0': 11, '1': 12, '2': 13, '3': 14, '4': 15, '5': 16, '6': 17, '8': 19, '10': 21, '12': 23, '13': 24 },
    'G3': { '0': 7, '1': 8, '2': 9, '3': 10, '4': 11, '5': 12, '7': 14, '9': 16, '10': 17, '12': 19 },
    'D3': { '0': 2, '2': 4, '3': 5, '4': 6, '5': 7, '6': 8, '7': 9, '9': 11, '10': 12, '12': 14 },
    'A2': { '0': 9, '2': 11, '3': 12, '4': 13, '5': 14, '6': 15, '7': 16, '8': 17, '10': 19, '11': 20, '12': 21 },
    'E2': { '0': 4, '1': 5, '2': 6, '3': 7, '5': 9, '7': 11, '8': 12, '10': 14, '12': 16, '13': 17 },
};
// --- END SECTION 3 ---

const C_MAJOR_ROOT_INDEX = 0; // C = 0


// --- RE-COMPOSED: 4-STRING BASS CONSTANTS (EADG) ---

const C_MAJOR_BASS_8_MEASURE_LOOP = {
    'G3': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','2','-','4','-','-','-','-','-','-','-','-','-','-','-', // M7
        '0','-','-','-','4','-','2','-','0','-','-','-','-','-','-','-', // M8
    ],
    'D3': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '2','-','3','-','5','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','5','-','3','-','2','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '-','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M3
        '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'A2': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M5
        '-','-','-','-','3','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'E2': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','1','-','3','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
};
// Repeat the 8-measure loop to create the full 32-measure (512-beat) exercise
const C_MAJOR_BASS_TAB = {
    'G3': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['G3']
    ],
    'D3': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['D3']
    ],
    'A2': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['A2']
    ],
    'E2': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['E2']
    ]
};
// --- UPDATED: Note map for new playable bass �tude ---
const C_MAJOR_BASS_NOTE_MAP = {
    'G3': { '0': 7, '2': 9, '4': 11, '5': 12 },
    'D3': { '0': 2, '2': 4, '3': 5, '5': 7 },
    'A2': { '3': 12, '5': 14 },
    'E2': { '0': 4, '1': 5, '3': 7 }
};
// --- END 4-STRING BASS CONSTANTS ---


// --- RE-COMPOSED: MANDOLIN CONSTANTS (GDAE) ---
// --- This loop is 8 measures, repeated 4 times ---
const C_MAJOR_MANDOLIN_8_MEASURE_LOOP = {
    'E5': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','1','-','3','-','5','-','5','-','3','-','1','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '0','-','-','-','5','-','-','-','0','-','-','-','5','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','5','-','-','-','1','-','-','-','5','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','7','-','-','-','3','-','-','-','7','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'A4': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '0','-','2','-','3','-','-','-','3','-','2','-','0','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '2','-','-','-','-','-','-','-','2','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M8
    ],
    'D4': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','2','-','3','-','5','-','5','-','3','-','2','-','0','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '2','-','-','-','-','-','-','-','2','-','-','-','-','-','-','-', // M3
        '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M8
    ],
    'G3': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','2','-','4','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '0','-','-','-','5','-','-','-','0','-','-','-','5','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','5','-','-','-','1','-','-','-','5','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','7','-','-','-','3','-','-','-','7','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'C2': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M8
    ],
};
// Repeat the 8-measure loop to create the full 32-measure (512-beat) exercise
const C_MAJOR_MANDOLIN_TAB = {
    'E5': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5']
    ],
    'A4': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4']
    ],
    'D4': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4']
    ],
    'G3': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3']
    ]
};
// --- UPDATED: Note map for new playable mandolin �tude ---
const C_MAJOR_MANDOLIN_NOTE_MAP = {
    'E5': { '0': 4, '1': 5, '3': 7, '5': 9, '7': 11 },
    'A4': { '0': 9, '2': 11, '3': 12, '5': 14 },
    'D4': { '0': 2, '2': 4, '3': 5, '5': 7 },
    'G3': { '3': 10, '5': 12 } // Corrected G3 to G3
};
// --- END MANDOLIN CONSTANTS ---


// --- RE-COMPOSED: 5-STRING BANJO CONSTANTS (gDGBD) ---
// --- This loop is 8 measures, repeated 4 times ---
const C_MAJOR_BANJO_8_MEASURE_LOOP = {
    'G4': [ // High G Drone (String 5)
        // C "Forward Roll" (M1-2)
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M1
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M2
        // F "Forward Roll" (M3-4)
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M3
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M4
        // G "Forward Roll" (M5-6)
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M5
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M6
        // C Scale Riff (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M8
    ],
    'D4': [ // 1st String
        // C "Forward Roll" (M1-2)
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // F "Forward Roll" (M3-4)
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M3
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M4
        // G "Forward Roll" (M5-6)
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M5
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '5','-','3','-','1','-','0','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'B3': [ // 2nd String
        // C "Forward Roll" (M1-2)
        '-','-','1','-','-','-','1','-','-','-','1','-','-','-','1','-', // M1
        '-','-','1','-','-','-','1','-','-','-','1','-','-','-','1','-', // M2
        // F "Forward Roll" (M3-4)
        '-','-','3','-','-','-','3','-','-','-','3','-','-','-','3','-', // M3
        '-','-','3','-','-','-','3','-','-','-','3','-','-','-','3','-', // M4
        // G "Forward Roll" (M5-6)
        '-','-','0','-','-','-','0','-','-','-','0','-','-','-','0','-', // M5
        '-','-','0','-','-','-','0','-','-','-','0','-','-','-','0','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '-','-','-','-','-','-','-','-','3','-','1','-','0','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'G3': [ // 3rd String
        // C "Forward Roll" (M1-2)
        '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M1
        '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M2
        // F "Forward Roll" (M3-4)
        '-','2','-','-','-','2','-','-','-','2','-','-','-','2','-','-', // M3
        '-','2','-','-','-','2','-','-','-','2','-','-','-','2','-','-', // M4
        // G "Forward Roll" (M5-6)
        '-','0','-','-','-','0','-','-','-','0','-','-','-','-','0','-','-','-','-','-','-','-', // M5
        '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '0','-','2','-','4','-','5','-','5','-','4','-','2','-','0','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'D3': [ // 4th String
        // C "Forward Roll" (M1-2)
        '2','-','-','-','2','-','-','-','2','-','-','-','2','-','-','-', // M1
        '2','-','-','-','2','-','-','-','2','-','-','-','2','-','-','-', // M2
        // F "Forward Roll" (M3-4)
        '3','-','-','-','3','-','-','-','3','-','-','-','3','-','-','-', // M3
        '3','-','-','-','3','-','-','-','3','-','-','-','3','-','-','-', // M4
        // G "Forward Roll" (M5-6)
        '0','-','-','-','0','-','-','-','0','-','-','-','0','-','-','-', // M5
        '0','-','-','-','0','-','-','-','0','-','-','-','0','-','-','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
};
const C_MAJOR_BANJO_TAB = {
    'G4': [...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4']],
    'D4': [...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4']],
    'B3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3']],
    'G3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3']],
    'D3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3']]
};
// --- UPDATED: Note map for new playable banjo �tude ---
const C_MAJOR_BANJO_NOTE_MAP = {
    'G4': { '0': 7 }, // Drone string
    'D4': { '0': 2, '1': 3, '3': 5, '5': 7 },
    'B3': { '0': 11, '1': 12, '3': 14 },
    'G3': { '0': 7, '2': 9, '4': 11, '5': 12 },
    'D3': { '0': 2, '2': 4, '3': 5, '5': 7 }
};
// --- END 5-STRING BANJO CONSTANTS ---


// --- RE-COMPOSED: 7-STRING GUITAR CONSTANTS (BEADGBe) ---
// --- This loop is 8 measures, repeated 4 times ---
const C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP = {
    'B1': [ 
        // C Scale Riff (M1-2) - 8th notes
        '1','-','3','-','5','-','-','-','5','-','3','-','1','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '1','-','-','-','5','-','-','-','8','-','-','-','5','-','-','-', // M3
        '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '1','-','-','-','6','-','-','-','10','-','-','-','6','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','8','-','-','-','12','-','-','-','8','-','-','-', // M7
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
};
const C_MAJOR_GUITAR_7_STRING_TAB = {
    'e4': [...C_MAJOR_BASE_TAB['e4']], // Reuse 6-string part
    'B3': [...C_MAJOR_BASE_TAB['B3']], // Reuse 6-string part
    'G3': [...C_MAJOR_BASE_TAB['G3']], // Reuse 6-string part
    'D3': [...C_MAJOR_BASE_TAB['D3']], // Reuse 6-string part
    'A2': [...C_MAJOR_BASE_TAB['A2']], // Reuse 6-string part
    'E2': [...C_MAJOR_BASE_TAB['E2']], // Reuse 6-string part
    'B1': [ // New 32-measure part (8-measure loop repeated 4x)
        ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'], ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'],
        ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'], ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1']
    ],
};
// --- UPDATED: Note map for new 7-string part ---
const C_MAJOR_GUITAR_7_STRING_NOTE_MAP = {
    ...C_MAJOR_BASE_NOTE_MAP, // Inherit all 6-string maps
    'B1': { '1': 12, '3': 14, '5': 16, '6': 17, '8': 19, '10': 21, '12': 23 } // Add B1 frets
};
// --- END 7-STRING GUITAR CONSTANTS ---


// --- CORE LOGIC FUNCTIONS ---

function getNoteName(startNoteIndex, startOctave, fret) {
    const totalHalfSteps = startNoteIndex + fret;
    const noteIndex = totalHalfSteps % 12;
    const octave = startOctave + Math.floor(totalHalfSteps / 12); 

    const noteData = CHROMATIC_NOTES[noteIndex];
    const primaryName = noteData.name;
    const displayNote = noteData.aliases.length > 0 ? `${primaryName}/${noteData.aliases[0]}` : primaryName;

    return {
        full: `${displayNote}${octave}(${fret})`,
        name_only: displayNote,
        index: noteIndex,
        octave: octave
    };
}

function isNoteInScale(noteIndex, rootIndex, scaleIntervals) {
    const relativeIndex = (noteIndex - rootIndex + 12) % 12;
    return scaleIntervals.includes(relativeIndex);
}

function getOrdinal(n) {
    if (10 <= n % 100 && n % 100 <= 20) return `${n}th`;
    return { 1: `${n}st`, 2: `${n}nd`, 3: `${n}rd` }[n % 10] || `${n}th`;
}

function getRootOptions() {
    return CHROMATIC_NOTES.reduce((acc, note, index) => {
        const name = note.name + (note.aliases.length > 0 ? `/${note.aliases[0]}` : '');
        acc[name] = index;
        return acc;
    }, {});
}

function buildInstrumentData(instrumentKey, rootIndex, scaleIntervals) {
    const tuning = TUNINGS[instrumentKey].tuning;
    const fretboardData = [];
    
    // Determine number of frets to display
    let fretCount = NUM_FRETS; // Use global
    if (instrumentKey.includes('Banjo')) {
        fretCount = 10;
    } else if (instrumentKey.includes('Mandolin')) {
        fretCount = 12;
    }

    for (const stringInfo of tuning) {
        const row = {
            stringName: stringInfo.label, // 'e', 'B', 'G', 'D', 'A', 'E'
            open_note_full: `${stringInfo.open_note}(0)`,
            open_note_name: stringInfo.open_note,
            label: stringInfo.label,
            ordinal: getOrdinal(stringInfo.string),
            cells: [],
            thickness: stringInfo.thickness,
            string_index: stringInfo.string,
            base_note_index: stringInfo.note_index // Store base index for transposition
        };

        for (let fret = 0; fret <= fretCount; fret++) {
            let noteValue = '---';
            let isRoot = false;
            let noteName = '';
            
            // Banjo 5th string (drone string) typically ends at fret 5
            const isDroneString = instrumentKey.includes('Banjo') && stringInfo.string === 5;
            if (isDroneString && fret > 5) {
                row.cells.push({ fret, value: noteValue, is_root: false, name: '', is_scale: false, note_index: -1 });
                continue;
            }

            const note = getNoteName(stringInfo.note_index, stringInfo.octave, fret);
            let isScale = false;

            if (isNoteInScale(note.index, rootIndex, scaleIntervals)) {
                noteValue = note.full;
                noteName = note.name_only;
                isScale = true;
                if (note.index === rootIndex) {
                    isRoot = true;
                }
            }

            row.cells.push({
                fret,
                value: noteValue,
                is_root: isRoot,
                is_scale: isScale,
                name: noteName,
                note_index: note.index
            });
        }
        fretboardData.push(row);
    }
    // Data is [Thin (idx 0) ... Thick (idx N-1)]
    return fretboardData;
}

// --- RENDERING FUNCTIONS (GUI and Tables) ---

function renderGui(fretboardData, instrumentKey, handedness, showNotes) {
    const numStrings = fretboardData.length;
    const fretCount = fretboardData[0].cells.length - 1;

    const fretboardGui = document.createElement('div');
    fretboardGui.className = 'fretboard-gui';
    fretboardGui.style.height = `${numStrings * STRING_PITCH_GAP + 50}px`; 

    // Calculate GUI width
    const guiWidth = fretCount * FRET_SPACING + FRET_SPACING; // Max frets * spacing + 1 additional space for Fret 0
    fretboardGui.style.minWidth = `${guiWidth}px`;

    // Draw Frets (Vertical Lines)
    for (let f = 0; f <= fretCount; f++) {
        const fretPos = f * FRET_SPACING;
        const fretEl = document.createElement('div');
        fretEl.className = 'fret';
        fretEl.style.left = `${fretPos}px`;
        fretEl.style.width = '1px';
        
        if (f > 0) {
            fretEl.style.transform = 'translateX(-1px)';
        } else {
            fretEl.style.borderLeft = '6px solid #aaa'; // Nut (Fret 0 marker)
            fretEl.style.left = '0';
            fretEl.style.zIndex = '50';
        }
        fretboardGui.appendChild(fretEl);

        // Fret Markers (Dots)
        const midPointY = (30 + (numStrings - 1) * STRING_PITCH_GAP + 30) / 2; // Midpoint between first and last string
        if ([3, 5, 7, 9, 15].includes(f) && f <= fretCount) {
            const marker = document.createElement('div');
            marker.className = 'fret-marker';
            marker.style.left = `${fretPos + (FRET_SPACING / 2)}px`; 
            marker.style.top = `${midPointY}px`;
            fretboardGui.appendChild(marker);
        }
        if (f === 12 && f <= fretCount) {
            const marker1 = document.createElement('div');
            marker1.className = 'fret-marker';
            marker1.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
            marker1.style.top = `${midPointY - STRING_PITCH_GAP}px`;
            fretboardGui.appendChild(marker1);

            const marker2 = document.createElement('div');
            marker2.className = 'fret-marker';
            marker2.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
            marker2.style.top = `${midPointY + STRING_PITCH_GAP}px`;
            fretboardGui.appendChild(marker2);
        }

        // Fret Number Label
        const numLabel = document.createElement('div');
        numLabel.className = 'fret-number';
        
        if (f === 0) {
            numLabel.textContent = '0';
            numLabel.style.left = `${FRET_SPACING / 2}px`; 
            fretboardGui.appendChild(numLabel);
        } else if (f <= fretCount) {
            numLabel.textContent = f;
            numLabel.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
            fretboardGui.appendChild(numLabel);
        }
    }
    
    // Draw Strings and Notes
    
    // Determine string order for rendering
    let orderedStrings = [...fretboardData];
    if (handedness === 'right') {
        // RIGHT-HANDED: Player View (Thinnest string on top, Thickest string on bottom)
        orderedStrings.sort((a, b) => a.thickness - b.thickness);
    } else {
        // LEFT-HANDED: Mirrored View (Thickest string on top, Thinnest string on bottom)
        orderedStrings.sort((a, b) => b.thickness - a.thickness);
    }

    // Find the maximum thickness to normalize string heights
    const maxThickness = orderedStrings.reduce((max, s) => Math.max(max, s.thickness), 0);
    
    orderedStrings.forEach((stringData, stringIndex) => {
        // String vertical position
        const stringY = 30 + stringIndex * STRING_PITCH_GAP; 

        // String wire
        const stringEl = document.createElement('div');
        stringEl.className = 'string';
        stringEl.style.top = `${stringY}px`;
        
        const lineHeight = 1 + (stringData.thickness / maxThickness) * 2; 
        stringEl.style.height = `${lineHeight}px`; 
        
        fretboardGui.appendChild(stringEl);

        // String label (open note name)
        const labelEl = document.createElement('div');
        labelEl.className = 'string-label';
        labelEl.textContent = stringData.open_note_name;
        labelEl.style.top = `${stringY}px`;
        fretboardGui.appendChild(labelEl);

        // Place notes (dots)
        stringData.cells.forEach(cell => {
            if (cell.is_scale && cell.fret >= 0) {
                const dotEl = document.createElement('div');
                dotEl.className = `fret-dot ${cell.is_root ? 'root' : 'scale'}`;
                
                // Use showNotes to determine content
                const dotContent = showNotes ? cell.name.split('/')[0] : (cell.is_root ? 'R' : '');
                dotEl.textContent = dotContent;

                let xPos;
                const dotSize = 24; // 1.5rem

                if (cell.fret === 0) {
                     xPos = (FRET_SPACING / 2);
                } else {
                    xPos = (cell.fret * FRET_SPACING) + (FRET_SPACING / 2);
                }

                dotEl.style.left = `${xPos}px`;
                dotEl.style.top = `${stringY}px`;
                
                const isDroneString = instrumentKey.includes('Banjo') && stringData.string_index === 5;
                if (isDroneString && cell.fret > 5) return;

                fretboardGui.appendChild(dotEl);
            }
        });
    });

    const guiWrapper = document.createElement('div');
    guiWrapper.className = 'fretboard-container';
    guiWrapper.appendChild(fretboardGui);
    
    return guiWrapper;
}

function renderTable1(fretboardData, rootName, modeName, showNotes) {
    // Orientation 1: Strings as Rows (Thin to Thick, top to bottom)
    const fretCount = fretboardData[0].cells.length - 1;

    // Sort data: Thin (top row) to Thick (bottom row)
    let orderedStrings = [...fretboardData].sort((a, b) => a.thickness - b.thickness);

    let html = `<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Strings as Rows (Thinnest String at Top)</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">String</th>
                        ${Array.from({ length: fretCount + 1 }, (_, i) => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Fret ${i}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${orderedStrings.map(stringData => {
                        const stringLabel = `${stringData.label} (${stringData.open_note_name})`;
                        return `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stringLabel}</td>
                            ${stringData.cells.map(note => {
                                const isRoot = note.is_root;
                                const isScale = note.is_scale && !isRoot;
                                let classes = 'px-2 py-4 whitespace-nowrap text-center text-sm font-bold';
                                if (isRoot) {
                                    classes += ' bg-red-100 text-red-800 rounded-lg';
                                } else if (isScale) {
                                    classes += ' bg-indigo-100 text-indigo-800 rounded-lg';
                                } else {
                                    classes += ' text-gray-400';
                                }
                                const display = showNotes ? (note.is_scale ? note.name : '-') : (note.is_scale ? (isRoot ? 'R' : 'X') : '-');
                                return `<td class="${classes}">${display}</td>`;
                            }).join('')}
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
    return html;
}

function renderTable2(fretboardData, rootName, modeName, handedness, showNotes) {
    // Orientation 2: Frets as Rows (Transposed - Handedness Specific)
    const fretCount = fretboardData[0].cells.length - 1;

    // Determine column order based on handedness
    let stringsToRender = [...fretboardData];
    if (handedness === 'right') {
        // Right-Handed: Thickest (Left) to Thinnest (Right)
        stringsToRender.sort((a, b) => b.thickness - a.thickness);
    } else {
        // Left-Handed: Thinnest (Left) to Thickest (Right)
        stringsToRender.sort((a, b) => a.thickness - b.thickness);
    }

    // Headers (Strings)
    const stringHeaders = stringsToRender.map(s => `${s.label} (${s.open_note_name})`);
    
    let html = `<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Frets as Rows (Fretboard Map)</h3>
        <p class="text-sm text-gray-500 mb-4">String order reflects the player's perspective (${handedness}-handed).</p>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fret</th>
                        ${stringHeaders.map(label => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${label}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${Array.from({ length: fretCount + 1 }, (_, f) => {
                        return `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Fret ${f}</td>
                            ${stringsToRender.map(stringData => {
                                const note = stringData.cells[f];
                                const isRoot = note.is_root;
                                const isScale = note.is_scale && !isRoot;
                                let classes = 'px-2 py-4 whitespace-nowrap text-center text-sm font-bold';
                                if (isRoot) {
                                    classes += ' bg-red-100 text-red-800 rounded-lg';
                                } else if (isScale) {
                                    classes += ' bg-indigo-100 text-indigo-800 rounded-lg';
                                } else {
                                    classes += ' text-gray-400';
                                }
                                const display = showNotes ? (note.is_scale ? note.name : '-') : (note.is_scale ? (isRoot ? 'R' : 'X') : '-');
                                return `<td class="${classes}">${display}</td>`;
                            }).join('')}
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
    return html;
}

// --- NEW: TABLATURE PLAYBACK LOGIC (Part VII) ---

/**
 * Parses the transposed tab data into an array of events for Tone.js.
 * @param {object} transposedTab - The tab object, e.g., { e4: ['0', '1', '-'], ... }
 * @param {object} stringDataMap - Map of string data for note calculation.
 * @param {number} tempo - The BPM for playback.
 * @returns {Array} An array of playable events for Tone.Part.
 */
function parseTabToPlayableEvents(transposedTab, stringDataMap, tempo) {
    const playableEvents = [];
    const timePerBeat = 60 / tempo / 4; // Time for one 16th note
    const noteDuration = "16n";

    const stringNames = Object.keys(transposedTab);
    if (stringNames.length === 0) return [];

    const totalNotes = transposedTab[stringNames[0]].length;

    for (let i = 0; i < totalNotes; i++) { // Iterate through each time step (16th note)
        for (const stringFullName of stringNames) { // e.g., 'e4', 'B3'
            const fret = transposedTab[stringFullName][i];

            // Check for a playable note
            if (fret !== '-' && fret !== '?' && fret !== undefined) {
                const stringData = stringDataMap[stringFullName];
                if (!stringData) continue;

                // a. Calculate time
                const time = i * timePerBeat;

                // b. Calculate note name using Tonal.js
                const baseMidi = Tonal.Note.midi(stringData.open_note_name);
                if (baseMidi === undefined) continue;

                const noteMidi = baseMidi + parseInt(fret, 10);
                const noteName = Tonal.Note.fromMidi(noteMidi);

                // c. Add the event object
                playableEvents.push({
                    time: time,
                    note: noteName,
                    duration: noteDuration
                });
            }
        }
    }
    return playableEvents;
}

/**
 * Plays the parsed tablature using Tone.js.
 * @param {Array} playableEvents - The array of note objects from the parser.
 */
async function playTablature(playableEvents) {
    if (playableEvents.length === 0) {
        console.log("No notes to play.");
        return;
    }

    await Tone.start(); // Ensure AudioContext is running
    stopTablature(); // Stop any previous playback

    currentTabPart = new Tone.Part((time, event) => {
        synth.triggerAttackRelease(event.note, event.duration, time);
    }, playableEvents).start(0);

    Tone.Transport.start();
}

/**
 * Stops the tablature playback.
 */
function stopTablature() {
    Tone.Transport.stop();
    Tone.Transport.cancel();
    if (currentTabPart) {
        currentTabPart.dispose();
        currentTabPart = null;
    }
}

// Global variable to store chord shapes
let chordShapesData = {};

// Load chord shapes from JSON file
async function loadChordShapes() {
    try {
        const response = await fetch('/chord_shapes.json');
        if (!response.ok) {
            console.error('Failed to load chord shapes');
            return;
        }
        chordShapesData = await response.json();
        console.log('Chord shapes loaded successfully');
    } catch (error) {
        console.error('Error loading chord shapes:', error);
    }
}

// Render a text-based chord diagram in LANDSCAPE orientation (ASCII style)
// Strings run horizontally (like looking at guitar from above)
function renderTextChordDiagram(chordData, numStrings = 6) {
    const frets = chordData.frets || [];
    const fingers = chordData.fingers || [];
    const title = chordData.title || '';
    
    // Find the highest fret used (for display range)
    const maxFret = Math.max(...frets.filter(f => f > 0));
    const startFret = maxFret > 4 ? Math.max(1, maxFret - 3) : 0;
    const displayFrets = maxFret > 4 ? 4 : 5; // Show 4-5 frets
    
    // String names (E A D G B e from bottom to top when looking at guitar)
    // In our display: high e at top, low E at bottom
    const stringNames = ['e', 'B', 'G', 'D', 'A', 'E'];
    const displayNames = stringNames.slice(0, numStrings);
    
    let diagram = '';
    
    // Title
    diagram += `<div class="chord-diagram-title">${title}</div>\n`;
    
    // Fret marker (if not open position)
    if (startFret > 0) {
        diagram += `<div class="chord-fret-marker">Position: ${startFret}fr</div>\n`;
    }
    
    // Build the landscape fretboard
    diagram += '<div class="chord-fretboard-landscape">\n';
    
    // For each string (high e to low E, top to bottom)
    for (let stringIdx = numStrings - 1; stringIdx >= 0; stringIdx--) {
        diagram += '<div class="chord-string-row">\n';
        
        // String name and x/o indicator on left
        const fret = frets[stringIdx];
        let indicator = '';
        if (fret === -1) {
            indicator = 'x';
        } else if (fret === 0 && startFret === 0) {
            indicator = 'o';
        } else {
            indicator = ' ';
        }
        
        diagram += `<div class="chord-string-label">${stringNames[numStrings - 1 - stringIdx]} ${indicator}</div>`;
        
        // Draw nut or edge
        if (startFret === 0) {
            diagram += '<div class="chord-nut">┃</div>'; // Thick nut line
        } else {
            diagram += '<div class="chord-edge">│</div>'; // Thin edge
        }
        
        // Draw each fret position
        for (let fretNum = startFret; fretNum < startFret + displayFrets; fretNum++) {
            const fingerFret = frets[stringIdx];
            const fingerNum = fingers[stringIdx];
            
            // Check if finger is on this fret
            if (fingerFret === fretNum + 1) {
                const label = fingerNum > 0 ? fingerNum.toString() : '●';
                diagram += `<div class="chord-fret-cell finger">${label}</div>`;
            } else {
                diagram += '<div class="chord-fret-cell">─</div>';
            }
            
            // Fret line
            diagram += '<div class="chord-fret-line">│</div>';
        }
        
        diagram += '</div>\n'; // End string row
    }
    
    // Fret numbers below
    diagram += '<div class="chord-fret-numbers">\n';
    diagram += '<div class="chord-string-label"></div>'; // Empty space for alignment
    diagram += '<div class="chord-edge"></div>'; // Empty space for nut/edge
    for (let fretNum = startFret; fretNum < startFret + displayFrets; fretNum++) {
        const displayNum = fretNum === 0 ? '' : fretNum + 1;
        diagram += `<div class="chord-fret-number">${displayNum}</div>`;
        diagram += '<div class="chord-fret-line"></div>'; // Empty space for fret line
    }
    diagram += '</div>\n';
    
    diagram += '</div>\n'; // End fretboard
    
    return diagram;
}

// CAGED chord shape templates (relative to root position)
// Each template is [string6, string5, string4, string3, string2, string1]
// -1 = muted, 0 = open (when at position 0), positive = fret offset from root position
const CAGED_TEMPLATES = {
    'Major': {
        'E-Shape': {
            pattern: [0, 2, 2, 1, 0, 0], // E Major shape (movable)
            fingers: [0, 3, 4, 2, 0, 0],
            baseFret: 0,
            name: 'E-Shape (LOW)'
        },
        'A-Shape': {
            pattern: [-1, 0, 2, 2, 2, 0], // A Major shape (movable)
            fingers: [0, 0, 3, 2, 1, 0],
            baseFret: 0,
            name: 'A-Shape (MID)'
        },
        'D-Shape': {
            pattern: [-1, -1, 0, 2, 3, 2], // D Major shape (movable)
            fingers: [0, 0, 0, 1, 3, 2],
            baseFret: 0,
            name: 'D-Shape (MID-HIGH)'
        },
        'C-Shape': {
            pattern: [-1, 3, 2, 0, 1, 0], // C Major shape (movable)
            fingers: [0, 4, 3, 0, 1, 0],
            baseFret: 0,
            name: 'C-Shape (HIGH)'
        }
    },
    'minor': {
        'Em-Shape': {
            pattern: [0, 2, 2, 0, 0, 0], // E minor shape (movable)
            fingers: [0, 2, 3, 0, 0, 0],
            baseFret: 0,
            name: 'Em-Shape (LOW)'
        },
        'Am-Shape': {
            pattern: [-1, 0, 2, 2, 1, 0], // A minor shape (movable)
            fingers: [0, 0, 3, 2, 1, 0],
            baseFret: 0,
            name: 'Am-Shape (MID)'
        },
        'Dm-Shape': {
            pattern: [-1, -1, 0, 2, 3, 1], // D minor shape (movable)
            fingers: [0, 0, 0, 2, 4, 1],
            baseFret: 0,
            name: 'Dm-Shape (MID-HIGH)'
        }
    }
};

// Helper function to calculate semitone distance between two notes
function getSemitoneDistance(fromNote, toNote) {
    const chromaticScale = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const enharmonicMap = {
        'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#'
    };
    
    // Normalize notes (handle enharmonics)
    const normalizeNote = (note) => {
        const pitchClass = Tonal.Note.pitchClass(note);
        return enharmonicMap[pitchClass] || pitchClass;
    };
    
    const from = normalizeNote(fromNote);
    const to = normalizeNote(toNote);
    
    const fromIndex = chromaticScale.indexOf(from);
    const toIndex = chromaticScale.indexOf(to);
    
    if (fromIndex === -1 || toIndex === -1) return null;
    
    // Calculate semitones (positive = up, can wrap around octave)
    let distance = toIndex - fromIndex;
    if (distance < 0) distance += 12;
    
    return distance;
}

// Generate multiple chord positions using CAGED system
function generateCAGEDChords(chordName, numStrings = 6) {
    try {
        const chord = Tonal.Chord.get(chordName);
        if (!chord.notes || chord.notes.length === 0) {
            return [];
        }
        
        const root = chord.tonic;
        const chordType = chord.quality || chord.aliases[0] || '';
        
        // Determine if it's major or minor
        let templates = null;
        if (chordType === '' || chordType === 'Major' || chordType === 'major') {
            templates = CAGED_TEMPLATES['Major'];
        } else if (chordType.includes('minor') || chordType === 'm') {
            templates = CAGED_TEMPLATES['minor'];
        }
        
        if (!templates) {
            return [];
        }
        
        // Find what fret the root note appears on different strings
        const tuning = ['E', 'A', 'D', 'G', 'B', 'E']; // Standard tuning note names
        
        const voicings = [];
        
        // Generate positions for each CAGED shape
        Object.entries(templates).forEach(([shapeName, template]) => {
            // Find where to position this shape based on root note
            // E-Shape: root on 6th string (E string)
            // A-Shape: root on 5th string (A string)
            // D-Shape: root on 4th string (D string)
            let rootString = 6;
            if (shapeName.includes('A-')) rootString = 5;
            if (shapeName.includes('D-') || shapeName.includes('C-')) rootString = 4;
            
            const openStringNote = tuning[6 - rootString];
            const semitoneOffset = getSemitoneDistance(openStringNote, root);
            
            if (semitoneOffset === null || semitoneOffset < 0) return;
            
            // Create chord at this position
            const frets = template.pattern.map((offset, idx) => {
                if (offset === -1) return -1; // Muted
                return semitoneOffset + offset;
            });
            
            // Skip if any fret is too high (>15)
            if (frets.some(f => f > 15)) return;
            
            voicings.push({
                name: shapeName,
                frets: frets,
                fingers: template.fingers,
                barres: [],
                title: `${chordName} (${template.name})` 
            });
        });
        
        return voicings;
        
    } catch (error) {
        console.error('Error generating CAGED chords:', error);
        return [];
    }
}

// Simple fallback for chords that don't fit CAGED patterns
function generateSimpleFallback(chordName, numStrings = 6) {
    try {
        const chord = Tonal.Chord.get(chordName);
        if (!chord.notes || chord.notes.length === 0) {
            return null;
        }
        
        const chordNotes = chord.notes;
        const tuning = ['E2', 'A2', 'D3', 'G3', 'B3', 'E4'];
        const stringTuning = tuning.slice(-numStrings);
        
        const frets = [];
        const fingers = [];
        
        // For each string, find the nearest chord tone within first 5 frets
        for (let s = 0; s < numStrings; s++) {
            const openNote = stringTuning[s];
            let foundFret = -1;
            
            for (let f = 0; f <= 4; f++) {
                const fretNote = Tonal.Note.transpose(openNote, Tonal.Interval.fromSemitones(f));
                const fretNoteName = Tonal.Note.pitchClass(fretNote);
                
                if (chordNotes.includes(fretNoteName)) {
                    foundFret = f;
                    break;
                }
            }
            
            frets.push(foundFret);
            fingers.push(foundFret > 0 ? foundFret : 0);
        }
        
        return {
            name: 'Generated',
            frets: frets,
            fingers: fingers,
            barres: [],
            title: `${chordName} (Auto-Generated)`
        };
    } catch (error) {
        console.error('Error generating fallback chord:', error);
        return null;
    }
}

// Initialize the Circle of Fifths and harmony section
function initializeKeyHarmonySection() {
    const circleOfFifths = document.querySelector('.circle-of-fifths');
    if (!circleOfFifths) return;

    // Circle of fifths keys in order
    const keys = ['C', 'G', 'D', 'A', 'E', 'B', 'F♯', 'D♭', 'A♭', 'E♭', 'B♭', 'F'];
    
    // Position keys in a circle
    const radius = 120;
    const centerX = 150;
    const centerY = 150;
    
    keys.forEach((key, index) => {
        const angle = (index * 30 - 90) * (Math.PI / 180); // 30 degrees apart, start at top
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        
        const keyButton = document.createElement('button');
        keyButton.className = 'key-button';
        keyButton.textContent = key;
        keyButton.style.left = `${x}px`;
        keyButton.style.top = `${y}px`;
        keyButton.style.transform = 'translate(-50%, -50%)';
        
        keyButton.addEventListener('click', () => setActiveKey(key));
        circleOfFifths.appendChild(keyButton);
    });
    
    // Select C major by default
    setTimeout(() => {
        const cButton = circleOfFifths.querySelector('.key-button');
        if (cButton) cButton.click();
    }, 100);
}

// Handle key selection
function selectKey(key) {
    // Normalize key for Tonal.js (convert Unicode ♯ to ASCII #)
    const normalizedKey = key.replace('♯', '#').replace('♭', 'b');
    
    // Get diatonic chords using Tonal.js
    const scale = Tonal.Scale.get(`${normalizedKey} major`);
    const chordNames = scale.notes.map((note, index) => {
        // Build triads: I, ii, iii, IV, V, vi, vii°
        const quality = ['', 'm', 'm', '', '', 'm', 'dim'][index];
        return note + quality;
    });
    
    // Display diatonic chords
    const chordDisplay = document.getElementById('diatonic-chords-display');
    if (chordDisplay) {
        chordDisplay.innerHTML = '';
        const romanNumerals = ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii°'];
        
        chordNames.forEach((chordName, index) => {
            const btn = document.createElement('button');
            btn.className = 'diatonic-chord-btn px-4 py-2 bg-white border-2 border-gray-300 rounded-lg font-semibold hover:border-indigo-500 hover:text-indigo-600';
            btn.innerHTML = `<span class="text-xs text-gray-500">${romanNumerals[index]}</span><br>${chordName}`;
            btn.addEventListener('click', () => displayChord(chordName, btn));
            chordDisplay.appendChild(btn);
        });
    }
    
    // Display common progressions
    displayProgressions(key, chordNames);
}

// Display a chord diagram (multiple positions)
function displayChord(chordName, buttonElement) {
    console.log('displayChord called with:', chordName);
    
    // Remove active class from all chord buttons
    document.querySelectorAll('.diatonic-chord-btn').forEach(btn => btn.classList.remove('active'));
    buttonElement.classList.add('active');
    
    // Get current instrument
    const instrumentSelect = document.getElementById('instrumentFilter');
    const instrumentKey = instrumentSelect ? instrumentSelect.value : 'guitar_6';
    const instrumentName = '6-String Guitar (EADGBe)'; // Default for now
    
    console.log('Instrument:', instrumentName);
    console.log('Available shapes:', chordShapesData);
    
    const container = document.getElementById("chord-display-container");
    
    let chordVoicings = [];
    
    // First, try to get database shapes
    const shapes = chordShapesData[instrumentName];
    if (shapes && shapes[chordName]) {
        chordVoicings = [...shapes[chordName]];
        console.log(`Found ${chordVoicings.length} database voicing(s) for ${chordName}`);
    }
    
    // Then add CAGED auto-generated positions
    console.log(`Generating CAGED positions for ${chordName}...`);
    const cagedVoicings = generateCAGEDChords(chordName, 6);
    
    if (cagedVoicings && cagedVoicings.length > 0) {
        // Merge: Add CAGED voicings that aren't duplicates of database chords
        cagedVoicings.forEach(caged => {
            // Simple duplicate check based on fret positions
            const isDuplicate = chordVoicings.some(existing => 
                JSON.stringify(existing.frets) === JSON.stringify(caged.frets)
            );
            if (!isDuplicate) {
                chordVoicings.push(caged);
            }
        });
        console.log(`Added ${cagedVoicings.length} CAGED positions`);
    }
    
    // If still no voicings, try simple fallback
    if (chordVoicings.length === 0) {
        console.log(`No voicings found, trying simple fallback for ${chordName}...`);
        const fallback = generateSimpleFallback(chordName, 6);
        if (fallback) {
            chordVoicings = [fallback];
        } else {
            container.innerHTML = `<p class="text-gray-500 italic">Unable to generate chord for ${chordName}</p>`;
            return;
        }
    }
    
    console.log(`Total voicings to display: ${chordVoicings.length}`);
    
    // Render all voicings side-by-side
    container.innerHTML = '<div class="chord-diagrams-container"></div>';
    const diagrams = container.querySelector('.chord-diagrams-container');
    
    chordVoicings.forEach((chordData, index) => {
        const diagramDiv = document.createElement('div');
        diagramDiv.className = 'chord-diagram-item';
        diagramDiv.innerHTML = renderTextChordDiagram(chordData, chordData.frets.length);
        diagrams.appendChild(diagramDiv);
    });
}

// Display common chord progressions
function displayProgressions(key, chordNames) {
    const progressionDisplay = document.getElementById('chord-progression-display');
    if (!progressionDisplay) return;
    
    const commonProgressions = [
        { name: 'I-IV-V', indices: [0, 3, 4] },
        { name: 'I-V-vi-IV', indices: [0, 4, 5, 3] },
        { name: 'ii-V-I', indices: [1, 4, 0] },
        { name: 'I-vi-IV-V', indices: [0, 5, 3, 4] }
    ];
    
    progressionDisplay.innerHTML = '<h4 class="font-semibold text-gray-700 mb-2">Common Progressions:</h4>';
    
    commonProgressions.forEach(prog => {
        const chords = prog.indices.map(i => chordNames[i]).join(' → ');
        const div = document.createElement('div');
        div.className = 'text-sm text-gray-600';
        div.innerHTML = `<strong>${prog.name}:</strong> ${chords}`;
        progressionDisplay.appendChild(div);
    });
}

function initializeAccordions() {
    const accordions = document.querySelectorAll('.accordion-container');
    accordions.forEach(accordion => {
        const header = accordion.querySelector('.accordion-header');
        const content = accordion.querySelector('.accordion-content');

        header.addEventListener('click', () => {
            const isActive = header.classList.contains('active');
            
            if (isActive) {
                header.classList.remove('active');
                content.style.maxHeight = null;
            } else {
                header.classList.add('active');
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    });
}

function initializeControls() {
    const instrumentSelect = document.getElementById('instrumentFilter');
    const rootSelect = document.getElementById('rootSelect');
    const modeSelect = document.getElementById('modeSelect');
    const generateBtn = document.getElementById('generate-btn');

    // Populate Instruments
    for (const key in TUNINGS) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = TUNINGS[key].name;
        instrumentSelect.appendChild(option);
    }

    // Populate Root Notes
    const rootOptions = getRootOptions();
    for (const name in rootOptions) {
        const option = document.createElement('option');
        option.value = rootOptions[name];
        option.textContent = name;
        rootSelect.appendChild(option);
    }

    // Populate Scales/Modes
    for (const category in SCALES) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category;
        for (const scale of SCALES[category]) {
            const option = document.createElement('option');
            option.value = scale.intervals.join(',');
            option.textContent = scale.name;
            optgroup.appendChild(option);
        }
        modeSelect.appendChild(optgroup);
    }

    const generate = () => {
        const instrumentKey = instrumentSelect.value;
        const rootIndex = parseInt(rootSelect.value, 10);
        const scaleIntervals = modeSelect.value.split(',').map(Number);
        const handedness = document.getElementById('handedness').value;
        const showNotes = document.getElementById('show-notes').checked;
        const orientation = document.querySelector('input[name="orientation"]:checked').value;

        const fretboardData = buildInstrumentData(instrumentKey, rootIndex, scaleIntervals);
        const outputDiv = document.getElementById('fretboard-output');
        outputDiv.innerHTML = ''; // Clear previous output

        // Add the GUI fretboard
        const gui = renderGui(fretboardData, instrumentKey, handedness, showNotes);
        outputDiv.appendChild(gui);

        // Always populate the dedicated "Strings as Rows" section below tablature
        const stringsRowsDisplay = document.getElementById('strings-rows-display');
        if (stringsRowsDisplay) {
            const table1 = renderTable1(fretboardData, rootSelect.options[rootSelect.selectedIndex].text, modeSelect.options[modeSelect.selectedIndex].text, showNotes);
            stringsRowsDisplay.innerHTML = table1;
        }

        // Only render Frets as Rows if selected (Strings as Rows is always in dedicated section)
        if (orientation === '2') {
            const table2 = renderTable2(fretboardData, rootSelect.options[rootSelect.selectedIndex].text, modeSelect.options[modeSelect.selectedIndex].text, handedness, showNotes);
            outputDiv.innerHTML += table2;
        }
    };

    generateBtn.addEventListener('click', generate);
    instrumentSelect.addEventListener('change', generate);
    rootSelect.addEventListener('change', generate);
    modeSelect.addEventListener('change', generate);
    document.getElementById('handedness').addEventListener('change', generate);
    document.getElementById('show-notes').addEventListener('change', generate);
    document.querySelectorAll('input[name="orientation"]').forEach(radio => {
        radio.addEventListener('change', generate);
    });

    generate(); // Initial generation
}


window.onload = async () => {
    await loadChordShapes(); // Load chord data first
    initializeControls(); // Setup controls and run initial generation
    initializeKeyHarmonySection(); // Setup the interactive harmony section
    initializeAccordions(); // Initialize all accordion elements
    await loadTabCsv(); // Load tablature data
    
    // Add event listeners for tablature regeneration when selections change
    const instrumentSelect = document.getElementById('instrumentFilter');
    const rootSelect = document.getElementById('rootSelect');
    const modeSelect = document.getElementById('modeSelect');
    
    if (instrumentSelect) {
        instrumentSelect.addEventListener('change', regenerateTabForCurrentSettings);
    }
    if (rootSelect) {
        rootSelect.addEventListener('change', regenerateTabForCurrentSettings);
    }
    if (modeSelect) {
        modeSelect.addEventListener('change', regenerateTabForCurrentSettings);
    }
    
    // Add play/stop button listeners
    document.getElementById("play-tab-btn")?.addEventListener("click", playManuscript);
    document.getElementById("stop-tab-btn")?.addEventListener("click", stopManuscript);
};

// ========== MANUSCRIPT METHOD FIXES ==========

// Global state for tab data
let manuscriptTabData = null;

// Centralized key selection function - syncs Circle of Fifths AND Root Note dropdown
function setActiveKey(key) {
    // Update Circle of Fifths button state
    document.querySelectorAll('.key-button').forEach(btn => {
        if (btn.textContent === key) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // Update Root Note dropdown to match
    const rootSelect = document.getElementById('rootSelect');
    if (rootSelect) {
        for (let i = 0; i < rootSelect.options.length; i++) {
            if (rootSelect.options[i].textContent === key) {
                rootSelect.selectedIndex = i;
                break;
            }
        }
    }
    
    // Update diatonic chords
    selectKey(key);
}

// Load and parse CSV
async function loadTabCsv() {
    try {
        const response = await fetch('/C_Major_Guitar_Tab_sequential.csv');
        const csvText = await response.text();
        manuscriptTabData = parseCsvToTabData(csvText);
        console.log('Tab CSV loaded successfully');
        renderAllPhases();
    } catch (error) {
        console.error('Error loading tab CSV:', error);
    }
}

function parseCsvToTabData(csvText) {
    const lines = csvText.split('\n');
    const tabData = { e4: [], B3: [], G3: [], D3: [], A2: [], E2: [] };
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const cells = line.split(',');
        const rowLabel = cells[0];
        
        if (tabData.hasOwnProperty(rowLabel)) {
            for (let j = 1; j <= 16 && j < cells.length; j++) {
                const fret = cells[j].trim();
                tabData[rowLabel].push(fret || '');
            }
        }
    }
    return tabData;
}

// Regenerate tablature when instrument/root/scale selections change
function regenerateTabForCurrentSettings() {
    if (!manuscriptTabData) return;
    
    const rootSelect = document.getElementById('rootSelect');
    const instrumentSelect = document.getElementById('instrumentFilter');
    const modeSelect = document.getElementById('modeSelect');
    
    if (!rootSelect || !instrumentSelect || !modeSelect) return;
    
    // Get current selections
    const selectedRootIndex = parseInt(rootSelect.value);
    const selectedInstrument = instrumentSelect.value;
    const selectedMode = modeSelect.options[modeSelect.selectedIndex].text;
    
    console.log(`Regenerating tab for: ${CHROMATIC_NOTES[selectedRootIndex].name} ${selectedMode} on ${selectedInstrument}`);
    
    // Calculate transposition interval from C (index 0) to selected root
    const transpositionInterval = selectedRootIndex; // Semitones to transpose
    
    // Transpose the tablature data and adapt to selected instrument
    const transposedTabData = transposeTabData(manuscriptTabData, transpositionInterval, selectedInstrument);
    
    // Temporarily store the transposed data
    const originalData = manuscriptTabData;
    manuscriptTabData = transposedTabData;
    
    // Re-render the tablature with selected instrument
    renderAllPhasesForInstrument(selectedInstrument);
    
    // Restore original data (keep base data unchanged)
    manuscriptTabData = originalData;
}

// Transpose tablature data by a given interval (in semitones) and adapt to selected instrument
function transposeTabData(tabData, semitones, instrumentKey = 'guitar_6') {
    const transposed = {};
    
    // Get the target instrument's tuning
    const targetTuning = TUNINGS[instrumentKey];
    if (!targetTuning) {
        console.error('Unknown instrument:', instrumentKey);
        return tabData;
    }
    
    // Get the source instrument's tuning (original is guitar_6)
    const sourceTuning = TUNINGS['guitar_6'];
    
    // Map source strings to target strings based on open note matching
    // For now, we'll use a simple approach: map by relative pitch
    targetTuning.tuning.forEach(targetString => {
        // Create consistent string key using label + octave (matches CSV format)
        // CSV uses: e4, B3, G3, D3, A2, E2
        const targetStringLabel = `${targetString.label}${targetString.octave}`;
        
        // Find closest matching source string or generate from pattern
        let sourceStringLabel = null;
        
        // Try to find exact match first based on open_note
        for (const sourceString of sourceTuning.tuning) {
            if (sourceString.open_note === targetString.open_note) {
                sourceStringLabel = `${sourceString.label}${sourceString.octave}`;
                break;
            }
        }
        
        // If no exact match, use the tablature pattern from closest source string
        if (!sourceStringLabel) {
            // For instruments with different string counts, map intelligently
            // Use the middle strings of the source as reference
            const sourceString = sourceTuning.tuning[Math.min(targetString.string - 1, sourceTuning.tuning.length - 1)];
            sourceStringLabel = `${sourceString.label}${sourceString.octave}`;
        }
        
        // Copy and transpose the tab data
        if (tabData[sourceStringLabel]) {
            transposed[targetStringLabel] = tabData[sourceStringLabel].map(fret => {
                if (!fret || fret === '' || fret === '-') return fret;
                
                const fretNum = parseInt(fret, 10);
                if (isNaN(fretNum)) return fret;
                
                // Transpose by adding semitones
                const newFret = fretNum + semitones;
                
                // Keep within reasonable fret range
                if (newFret < 0) return '-';
                if (newFret > 24) return '-';
                
                return newFret.toString();
            });
        } else {
            // Generate empty pattern for this string
            transposed[targetStringLabel] = new Array(512).fill('-');
        }
    });
    
    return transposed;
}

function renderAllPhases() {
    if (!manuscriptTabData) return;
    renderManuscriptPhase('complete-tab-display', 0, 512, 'guitar_6');
}

function renderAllPhasesForInstrument(instrumentKey) {
    if (!manuscriptTabData) return;
    renderManuscriptPhase('complete-tab-display', 0, 512, instrumentKey);
}

function renderManuscriptPhase(containerId, startBeat, endBeat, instrumentKey = 'guitar_6') {
    if (!manuscriptTabData) return;
    const container = document.getElementById(containerId);
    if (!container) return;
    
    // Get string configuration from the selected instrument
    const tuning = TUNINGS[instrumentKey];
    if (!tuning) {
        console.error('Unknown instrument:', instrumentKey);
        return;
    }
    
    // Extract string labels from tuning (in display order: thinnest to thickest for standard view)
    // Use label + octave format to match CSV data keys (e4, B3, G3, D3, A2, E2)
    const strings = tuning.tuning.map(s => `${s.label}${s.octave}`);
    const beatsPerMeasure = 4;
    const measuresPerBar = 4;
    const beatsPerBar = beatsPerMeasure * measuresPerBar;
    
    let html = '<div class="tab-container"><div class="tab-string-labels">';
    
    // Add string labels column
    strings.forEach(stringName => {
        html += `<div class="tab-string-label">${stringName}</div>`;
    });
    html += '</div><div class="tab-staff">';
    
    // Loop through beats, displaying all strings vertically at each beat
    for (let beat = startBeat; beat < endBeat; beat++) {
        // Add measure separator every 4 beats (but not at the start)
        if (beat > startBeat && (beat - startBeat) % beatsPerMeasure === 0) {
            html += '<div class="tab-measure-separator"></div>';
        }
        
        // Wrap to new bar every 16 beats
        if (beat > startBeat && (beat - startBeat) % beatsPerBar === 0) {
            html += '</div></div><div class="tab-container"><div class="tab-string-labels">';
            strings.forEach(stringName => {
                html += `<div class="tab-string-label">${stringName}</div>`;
            });
            html += '</div><div class="tab-staff">';
        }
        
        // Create a vertical column for this beat showing all strings
        html += '<div class="tab-beat-column">';
        strings.forEach(stringName => {
            const fret = manuscriptTabData[stringName]?.[beat];
            
            // Defensive check: warn if string data is missing
            if (!manuscriptTabData[stringName] && beat === startBeat) {
                console.warn(`Missing tablature data for string: ${stringName}`);
            }
            
            const displayFret = fret !== undefined && fret !== '' ? fret : '-';
            html += `<div class="tab-fret-cell">${displayFret}</div>`;
        });
        html += '</div>';
    }
    
    html += '</div></div>';
    container.innerHTML = html;
}

async function playManuscript() {
    if (!manuscriptTabData) {
        console.log('No tab data loaded');
        return;
    }
    
    await Tone.start();
    Tone.Transport.stop();
    Tone.Transport.cancel();
    
    const synth = new Tone.Synth().toDestination();
    Tone.Transport.bpm.value = 120;
    
    const strings = ['e4', 'B3', 'G3', 'D3', 'A2', 'E2'];
    const tuningMap = { 'e4': 64, 'B3': 59, 'G3': 55, 'D3': 50, 'A2': 45, 'E2': 40 };
    const playableEvents = [];
    const TIME_PER_BEAT = 0.125;
    
    strings.forEach(stringName => {
        manuscriptTabData[stringName]?.forEach((fret, beatIndex) => {
            if (fret && fret !== '' && fret !== '-') {
                const time = beatIndex * TIME_PER_BEAT;
                const baseMidi = tuningMap[stringName];
                const noteMidi = baseMidi + parseInt(fret, 10);
                const noteName = Tonal.Note.fromMidi(noteMidi);
                
                playableEvents.push({ time, note: noteName, duration: '16n' });
            }
        });
    });
    
    const tabPart = new Tone.Part((time, event) => {
        synth.triggerAttackRelease(event.note, event.duration, time);
    }, playableEvents);
    
    tabPart.start(0);
    Tone.Transport.start();
    
    console.log(`Playing ${playableEvents.length} notes`);
}

function stopManuscript() {
    Tone.Transport.stop();
    Tone.Transport.cancel();
    console.log('Playback stopped');
}
