import { TUNINGS, SCALES } from './database.js';
// --- CONSTANTS ---
const FRET_SPACING = 75; // Standard width for each fret segment in the GUI (in px)
const STRING_PITCH_GAP = 40; // Vertical gap between strings (in px)
const NUM_FRETS = 15; // Use a global fret count

// --- DATA DEFINITIONS ---

const CHROMATIC_NOTES = [
    { name: "C", aliases: [] },
    { name: "C?", aliases: ["D?"] },
    { name: "D", aliases: [] },
    { name: "D?", aliases: ["E?"] },
    { name: "E", aliases: [] },
    { name: "F", aliases: [] },
    { name: "F?", aliases: ["G?"] },
    { name: "G", aliases: [] },
    { name: "G?", aliases: ["A?"] },
    { name: "A", aliases: [] },
    { name: "A?", aliases: ["B?"] },
    { name: "B", aliases: [] }
];

// --- SECTION 1: CORRECTED CONSTANTS (from C_Major_Guitar_Tab_sequential.csv) ---

const NOTES_PER_BEAT = 4; // 16th notes
const DEFAULT_BEATS_PER_MEASURE = 4; // 4/4 time
const DEFAULT_NOTES_PER_MEASURE = DEFAULT_BEATS_PER_MEASURE * NOTES_PER_BEAT; // 16

// --- FIX: Updated totals based on the full CSV data (C_Major_Guitar_Tab_sequential.csv) ---
const TOTAL_MEASURES = 32;
const TOTAL_DEFAULT_NOTES = 512;
// --- END SECTION 1 ---


// --- SECTION 2: CORRECTED C_MAJOR_BASE_TAB (from C_Major_Guitar_Tab_sequential.csv) ---
// This 6-string guitar tab is left as-is, per user request.
const C_MAJOR_BASE_TAB = {
    'e4': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M6
        '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','10','12', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '0','-','-','-','-','1','3','-','-','-','-','0','1','-','-','3', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '-','-','3','2','-','-','-','-','1','0','-','-','-','-','-','-', // M17
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M18
        '-','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M19
        '2','2','-','-','4','4','-','-','1','1','-','-','4','-','-','-', // M20
        '-','-','-','-','4','-','4','-','2','-','2','-','-','-','-','0', // M21
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M22
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','4', // M23
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','0', // M24
        '3','1','0','-','-','-','-','-','-','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','5', // M26
        '8','7','5','-','-','-','-','-','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','-','-','-','-','-','-','10','12','13', // M28
        '13','12','10','-','-','-','-','-','-','-','-','-','-','-','-','-', // M29
        '-','-','-','-','-','-','-','-','-','-','3','1','-','2','-','-', // M30
        '-','-','2','-','1','3','-','-','-','-','-','-','-','-','-','-', // M31
        '12','10','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M32
    ],
    'B3': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','-','-','-','8','10','-','-', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '-','1','-','-','3','-','-','0','-','-','3','-','-','3','1','-', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '-','1','-','-','3','-','-','0','-','-','3','-','-','3','1','-', // M17
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M18
        '2','2','-','-','4','4','-','-','1','1','-','-','2','-','-','-', // M19
        '3','-','3','-','5','-','5','-','1','-','1','-','-','5','3','-', // M20
        '1','-','1','-','5','-','-','5','3','-','-','3','-','-','3','3', // M21
        '-','-','-','-','-','-','-','-','1','-','1','-','-','-','-','3', // M22
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','4','4', // M23
        '-','-','-','-','-','-','-','-','-','-','-','-','0','1','3','-', // M24
        '-','-','-','3','1','0','-','-','-','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','-','-','-','5','6','8','-', // M26
        '-','-','-','8','6','5','-','-','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','-','-','-','10','12','13','-','-','-', // M28
        '-','-','-','13','12','10','-','-','-','-','-','-','-','-','-','-', // M29
        '-','-','10','8','6','5','6','5','4','2','3','1','-','3','1','-', // M30
        '-','1','3','-','1','3','2','4','5','6','5','6','8','10','-','-', // M31
        '-','-','10','8','-','-','-','-','-','-','-','-','-','-','-','-', // M32
    ],
    'G3': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '0','2','0','4','2','4','2','0','4','0','2','0','4','0','4','2', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '4','2','4','0','2','0','2','4','2','4','2','0','2','4','2','4', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','-','-','-','5','7','9','-','-','-','-', // M13
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
        '-','-','4','2','-','-','-','-','2','0','-','-','-','-','-','-', // M15
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
        '0','-','-','-','-','1','3','-','-','-','-','0','2','-','-','4', // M17
        '1','1','-','-','2','2','-','-','0','0','-','-','-','-','-','-', // M18
        '2','-','2','-','4','-','4','-','0','-','0','-','-','2','4','-', // M19
        '2','-','-','2','4','-','-','4','2','-','-','2','-','-','-','2', // M20
        '2','-','-','2','4','4','-','-','2','2','-','-','-','2','-','2', // M21
        '0','-','0','-','4','-','4','-','0','-','-','0','-','-','2','2', // M22
        '-','-','-','-','-','-','-','-','1','-','1','-','-','2','-','2', // M23
        '-','-','-','-','-','-','-','-','-','0','2','4','-','-','-','-', // M24
        '-','-','-','-','-','-','4','2','0','-','-','-','-','-','-','-', // M25
        '-','-','-','-','-','-','-','-','-','5','7','9','-','-','-','-', // M26
        '-','-','-','-','-','-','7','5','-','-','-','-','-','-','-','-', // M27
        '-','-','-','-','-','-','-','9','10','12','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','12','10','9','-','-','-','-','-','-','-', // M29
        '10','9','9','7','5','4','5','4','3','2','0','2','1','2','0','3', // M30
        '3','0','2','1','2','0','2','3','4','5','4','5','7','9','9','10', // M31
        '-','-','-','-','9','7','5','-','-','-','-','-','-','-','-','-', // M32
    ],
    'D3': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        '0','2','0','3','2','3','2','0','3','0','2','0','3','0','3','2', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '3','2','3','0','2','0','2','3','2','3','2','0','2','3','2','3', // M10
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','-','-','-','3','5','7','-','-','-','-','-','-','-', // M13
        '-','-','3','2','-','-','-','-','2','0','-','-','-','-','-','-', // M14
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
        '0','-','-','-','-','2','3','-','-','-','-','0','2','-','-','3', // M16
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
        '2','-','2','-','3','-','3','-','0','-','0','-','2','-','-','-', // M18
        '2','-','-','2','4','-','-','4','2','-','-','2','-','-','-','4', // M19
        '0','-','-','-','2','-','-','-','3','-','-','-','-','-','-','-', // M20
        '3','3','-','-','-','-','-','-','-','-','-','-','3','-','-','3', // M21
        '2','-','-','2','4','-','-','4','2','2','-','-','-','2','-','2', // M22
        '2','-','2','-','3','-','3','-','0','-','-','0','2','-','-','2', // M23
        '-','-','-','-','-','-','0','2','3','-','-','-','-','-','-','-', // M24
        '-','-','-','-','-','-','-','-','-','-','-','-','3','2','0','-', // M25
        '-','-','-','-','-','-','5','7','9','-','-','-','-','-','-','-', // M26
        '-','-','-','-','-','-','-','-','7','5','-','-','-','-','-','-', // M27
        '-','-','-','-','9','10','12','-','-','-','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','-','-','-','12','10','9','-','-','-','-', // M29
        '10','9','7','5','7','6','7','5','4','2','0','3','2','0','2','4', // M30
        '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
        '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
    ],
    'A2': [
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '0','2','0','3','2','3','2','0','3','0','2','0','3','0','3','2', // M2
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
        '3','2','3','0','2','0','2','3','2','3','2','0','2','3','2','3', // M11
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
        '-','-','-','2','3','5','-','-','-','-','-','-','-','-','-','-', // M13
        '-','2','-','-','3','-','-','0','-','-','3','-','-','3','2','-', // M14
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
        '-','2','-','-','3','-','-','0','-','-','3','-','-','3','2','-', // M16
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
        '2','-','-','2','3','-','-','3','2','-','-','2','-','3','2','-', // M18
        '0','-','-','-','2','-','-','-','3','-','-','-','-','-','-','-', // M19
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M20
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','0', // M21
        '3','3','-','-','2','2','-','-','-','-','-','-','3','-','-','3', // M22
        '3','-','-','3','3','-','-','3','2','2','-','-','-','-','-','-', // M23
        '-','-','-','0','2','3','-','-','-','-','-','-','-','-','-','-', // M24
        '-','-','-','-','-','-','-','-','-','-','-','-','3','2','0','-', // M25
        '-','-','-','-','-','-','5','7','8','-','-','-','-','-','-','-', // M26
        '-','-','-','-','-','-','-','-','-','-','8','7','5','-','-','-', // M27
        '-','-','10','12','-','-','-','-','-','-','-','-','-','-','-','-', // M28
        '-','-','-','-','-','-','-','-','-','-','-','-','12','10','-','-', // M29
        '12','11','8','6','8','7','5','3','2','0','-','-','2','-','3','4', // M30
        '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
        '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
    ],
};
// --- END SECTION 2 ---


// --- SECTION 3: C_MAJOR_BASE_NOTE_MAP (6-String Guitar) ---
// This map is left as-is, per user request.
const C_MAJOR_BASE_NOTE_MAP = {
    'e4': { '0': 4, '1': 5, '2': 6, '3': 7, '4': 8, '5': 9, '7': 11, '8': 12, '10': 14, '12': 16, '13': 17 },
    'B3': { '0': 11, '1': 12, '2': 13, '3': 14, '4': 15, '5': 16, '6': 17, '8': 19, '10': 21, '12': 23, '13': 24 },
    'G3': { '0': 7, '1': 8, '2': 9, '3': 10, '4': 11, '5': 12, '7': 14, '9': 16, '10': 17, '12': 19 },
    'D3': { '0': 2, '2': 4, '3': 5, '4': 6, '5': 7, '6': 8, '7': 9, '9': 11, '10': 12, '12': 14 },
    'A2': { '0': 9, '2': 11, '3': 12, '4': 13, '5': 14, '6': 15, '7': 16, '8': 17, '10': 19, '11': 20, '12': 21 },
    'E2': { '0': 4, '1': 5, '2': 6, '3': 7, '5': 9, '7': 11, '8': 12, '10': 14, '12': 16, '13': 17 },
};
// --- END SECTION 3 ---

const C_MAJOR_ROOT_INDEX = 0; // C = 0


// --- RE-COMPOSED: 4-STRING BASS CONSTANTS (EADG) ---

const C_MAJOR_BASS_8_MEASURE_LOOP = {
    'G3': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','2','-','4','-','-','-','-','-','-','-','-','-','-','-', // M7
        '0','-','-','-','4','-','2','-','0','-','-','-','-','-','-','-', // M8
    ],
    'D3': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '2','-','3','-','5','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','5','-','3','-','2','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '-','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M3
        '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'A2': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M5
        '-','-','-','-','3','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'E2': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','1','-','3','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
};
// Repeat the 8-measure loop to create the full 32-measure (512-beat) exercise
const C_MAJOR_BASS_TAB = {
    'G3': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['G3']
    ],
    'D3': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['D3']
    ],
    'A2': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['A2']
    ],
    'E2': [
        ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'],
        ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['E2']
    ]
};
// --- UPDATED: Note map for new playable bass étude ---
const C_MAJOR_BASS_NOTE_MAP = {
    'G3': { '0': 7, '2': 9, '4': 11, '5': 12 },
    'D3': { '0': 2, '2': 4, '3': 5, '5': 7 },
    'A2': { '3': 12, '5': 14 },
    'E2': { '0': 4, '1': 5, '3': 7 }
};
// --- END 4-STRING BASS CONSTANTS ---


// --- RE-COMPOSED: MANDOLIN CONSTANTS (GDAE) ---
// --- This loop is 8 measures, repeated 4 times ---
const C_MAJOR_MANDOLIN_8_MEASURE_LOOP = {
    'E5': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','1','-','3','-','5','-','5','-','3','-','1','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '0','-','-','-','5','-','-','-','0','-','-','-','5','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','5','-','-','-','1','-','-','-','5','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','7','-','-','-','3','-','-','-','7','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'A4': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '0','-','2','-','3','-','-','-','3','-','2','-','0','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '2','-','-','-','-','-','-','-','2','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M8
    ],
    'D4': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','2','-','3','-','5','-','5','-','3','-','2','-','0','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '2','-','-','-','-','-','-','-','2','-','-','-','-','-','-','-', // M3
        '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M8
    ],
    'G3': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '0','-','2','-','4','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '0','-','-','-','5','-','-','-','0','-','-','-','5','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','5','-','-','-','1','-','-','-','5','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','7','-','-','-','3','-','-','-','7','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'C2': [
        // C Major Scale (Pos 1) (M1-2) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M8
    ],
};
// Repeat the 8-measure loop to create the full 32-measure (512-beat) exercise
const C_MAJOR_MANDOLIN_TAB = {
    'E5': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5']
    ],
    'A4': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4']
    ],
    'D4': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4']
    ],
    'G3': [
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'],
        ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3']
    ]
};
// --- UPDATED: Note map for new playable mandolin étude ---
const C_MAJOR_MANDOLIN_NOTE_MAP = {
    'E5': { '0': 4, '1': 5, '3': 7, '5': 9, '7': 11 },
    'A4': { '0': 9, '2': 11, '3': 12, '5': 14 },
    'D4': { '0': 2, '2': 4, '3': 5, '5': 7 },
    'G3': { '3': 10, '5': 12 } // Corrected G3 to G3
};
// --- END MANDOLIN CONSTANTS ---


// --- RE-COMPOSED: 5-STRING BANJO CONSTANTS (gDGBD) ---
// --- This loop is 8 measures, repeated 4 times ---
const C_MAJOR_BANJO_8_MEASURE_LOOP = {
    'G4': [ // High G Drone (String 5)
        // C "Forward Roll" (M1-2)
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M1
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M2
        // F "Forward Roll" (M3-4)
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M3
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M4
        // G "Forward Roll" (M5-6)
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M5
        '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M6
        // C Scale Riff (M7-8) - 8th notes
        '0','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M8
    ],
    'D4': [ // 1st String
        // C "Forward Roll" (M1-2)
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // F "Forward Roll" (M3-4)
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M3
        '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M4
        // G "Forward Roll" (M5-6)
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M5
        '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '5','-','3','-','1','-','0','-','-','-','-','-','-','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'B3': [ // 2nd String
        // C "Forward Roll" (M1-2)
        '-','-','1','-','-','-','1','-','-','-','1','-','-','-','1','-', // M1
        '-','-','1','-','-','-','1','-','-','-','1','-','-','-','1','-', // M2
        // F "Forward Roll" (M3-4)
        '-','-','3','-','-','-','3','-','-','-','3','-','-','-','3','-', // M3
        '-','-','3','-','-','-','3','-','-','-','3','-','-','-','3','-', // M4
        // G "Forward Roll" (M5-6)
        '-','-','0','-','-','-','0','-','-','-','0','-','-','-','0','-', // M5
        '-','-','0','-','-','-','0','-','-','-','0','-','-','-','0','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '-','-','-','-','-','-','-','-','3','-','1','-','0','-','-','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'G3': [ // 3rd String
        // C "Forward Roll" (M1-2)
        '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M1
        '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M2
        // F "Forward Roll" (M3-4)
        '-','2','-','-','-','2','-','-','-','2','-','-','-','2','-','-', // M3
        '-','2','-','-','-','2','-','-','-','2','-','-','-','2','-','-', // M4
        // G "Forward Roll" (M5-6)
        '-','0','-','-','-','0','-','-','-','0','-','-','-','-','0','-','-','-','-','-','-','-', // M5
        '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '0','-','2','-','4','-','5','-','5','-','4','-','2','-','0','-', // M7
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
    'D3': [ // 4th String
        // C "Forward Roll" (M1-2)
        '2','-','-','-','2','-','-','-','2','-','-','-','2','-','-','-', // M1
        '2','-','-','-','2','-','-','-','2','-','-','-','2','-','-','-', // M2
        // F "Forward Roll" (M3-4)
        '3','-','-','-','3','-','-','-','3','-','-','-','3','-','-','-', // M3
        '3','-','-','-','3','-','-','-','3','-','-','-','3','-','-','-', // M4
        // G "Forward Roll" (M5-6)
        '0','-','-','-','0','-','-','-','0','-','-','-','0','-','-','-', // M5
        '0','-','-','-','0','-','-','-','0','-','-','-','0','-','-','-', // M6
        // C Scale Riff (M7-8) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
        '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
};
const C_MAJOR_BANJO_TAB = {
    'G4': [...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4']],
    'D4': [...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4']],
    'B3': [...C_major_banjo_8_measure_loop['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3']],
    'G3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3']],
    'D3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3']]
};
// --- UPDATED: Note map for new playable banjo étude ---
const C_MAJOR_BANJO_NOTE_MAP = {
    'G4': { '0': 7 }, // Drone string
    'D4': { '0': 2, '1': 3, '3': 5, '5': 7 },
    'B3': { '0': 11, '1': 12, '3': 14 },
    'G3': { '0': 7, '2': 9, '4': 11, '5': 12 },
    'D3': { '0': 2, '2': 4, '3': 5, '5': 7 }
};
// --- END 5-STRING BANJO CONSTANTS ---


// --- RE-COMPOSED: 7-STRING GUITAR CONSTANTS (BEADGBe) ---
// --- This loop is 8 measures, repeated 4 times ---
const C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP = {
    'B1': [ 
        // C Scale Riff (M1-2) - 8th notes
        '1','-','3','-','5','-','-','-','5','-','3','-','1','-','-','-', // M1
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
        // C Arpeggio (Pos 1) (M3-4) - 8th notes
        '1','-','-','-','5','-','-','-','8','-','-','-','5','-','-','-', // M3
        '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
        // F Arpeggio (Pos 1) (M5-6) - 8th notes
        '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
        '1','-','-','-','6','-','-','-','10','-','-','-','6','-','-','-', // M6
        // G Arpeggio (Pos 1) (M7-8) - 8th notes
        '3','-','-','-','8','-','-','-','12','-','-','-','8','-','-','-', // M7
        '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
    ],
};
const C_MAJOR_GUITAR_7_STRING_TAB = {
    'e4': [...C_MAJOR_BASE_TAB['e4']], // Reuse 6-string part
    'B3': [...C_MAJOR_BASE_TAB['B3']], // Reuse 6-string part
    'G3': [...C_MAJOR_BASE_TAB['G3']], // Reuse 6-string part
    'D3': [...C_MAJOR_BASE_TAB['D3']], // Reuse 6-string part
    'A2': [...C_MAJOR_BASE_TAB['A2']], // Reuse 6-string part
    'E2': [...C_MAJOR_BASE_TAB['E2']], // Reuse 6-string part
    'B1': [ // New 32-measure part (8-measure loop repeated 4x)
        ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'], ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'],
        ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'], ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1']
    ],
};
// --- UPDATED: Note map for new 7-string part ---
const C_MAJOR_GUITAR_7_STRING_NOTE_MAP = {
    ...C_MAJOR_BASE_NOTE_MAP, // Inherit all 6-string maps
    'B1': { '1': 12, '3': 14, '5': 16, '6': 17, '8': 19, '10': 21, '12': 23 } // Add B1 frets
};
// --- END 7-STRING GUITAR CONSTANTS ---


// --- CORE LOGIC FUNCTIONS ---

function getNoteName(startNoteIndex, startOctave, fret) {
    const totalHalfSteps = startNoteIndex + fret;
    const noteIndex = totalHalfSteps % 12;
    const octave = startOctave + Math.floor(totalHalfSteps / 12); 

    const noteData = CHROMATIC_NOTES[noteIndex];
    const primaryName = noteData.name;
    const displayNote = noteData.aliases.length > 0 ? `${primaryName}/${noteData.aliases[0]}` : primaryName;

    return {
        full: `${displayNote}${octave}(${fret})`,
        name_only: displayNote,
        index: noteIndex,
        octave: octave
    };
}

function isNoteInScale(noteIndex, rootIndex, scaleIntervals) {
    const relativeIndex = (noteIndex - rootIndex + 12) % 12;
    return scaleIntervals.includes(relativeIndex);
}

function getOrdinal(n) {
    if (10 <= n % 100 && n % 100 <= 20) return `${n}th`;
    return { 1: `${n}st`, 2: `${n}nd`, 3: `${n}rd` }[n % 10] || `${n}th`;
}

function getRootOptions() {
    return CHROMATIC_NOTES.reduce((acc, note, index) => {
        const name = note.name + (note.aliases.length > 0 ? `/${note.aliases[0]}` : '');
        acc[name] = index;
        return acc;
    }, {});
}

function buildInstrumentData(instrumentKey, rootIndex, scaleIntervals) {
    const tuning = TUNINGS[instrumentKey].tuning;
    const fretboardData = [];
    
    // Determine number of frets to display
    let fretCount = NUM_FRETS; // Use global
    if (instrumentKey.includes('Banjo')) {
        fretCount = 10;
    } else if (instrumentKey.includes('Mandolin')) {
        fretCount = 12;
    }

    for (const stringInfo of tuning) {
        const row = {
            stringName: stringInfo.label, // 'e', 'B', 'G', 'D', 'A', 'E'
            open_note_full: `${stringInfo.open_note}(0)`,
            open_note_name: stringInfo.open_note,
            label: stringInfo.label,
            ordinal: getOrdinal(stringInfo.string),
            cells: [],
            thickness: stringInfo.thickness,
            string_index: stringInfo.string,
            base_note_index: stringInfo.note_index // Store base index for transposition
        };

        for (let fret = 0; fret <= fretCount; fret++) {
            let noteValue = '---';
            let isRoot = false;
            let noteName = '';
            
            // Banjo 5th string (drone string) typically ends at fret 5
            const isDroneString = instrumentKey.includes('Banjo') && stringInfo.string === 5;
            if (isDroneString && fret > 5) {
                row.cells.push({ fret, value: noteValue, is_root: false, name: '', is_scale: false, note_index: -1 });
                continue;
            }

            const note = getNoteName(stringInfo.note_index, stringInfo.octave, fret);
            let isScale = false;

            if (isNoteInScale(note.index, rootIndex, scaleIntervals)) {
                noteValue = note.full;
                noteName = note.name_only;
                isScale = true;
                if (note.index === rootIndex) {
                    isRoot = true;
                }
            }

            row.cells.push({
                fret,
                value: noteValue,
                is_root: isRoot,
                is_scale: isScale,
                name: noteName,
                note_index: note.index
            });
        }
        fretboardData.push(row);
    }
    // Data is [Thin (idx 0) ... Thick (idx N-1)]
    return fretboardData;
}

// --- RENDERING FUNCTIONS (GUI and Tables) ---

function renderGui(fretboardData, instrumentKey, handedness, showNotes) {
    const numStrings = fretboardData.length;
    const fretCount = fretboardData[0].cells.length - 1;

    const fretboardGui = document.createElement('div');
    fretboardGui.className = 'fretboard-gui';
    fretboardGui.style.height = `${numStrings * STRING_PITCH_GAP + 50}px`; 

    // Calculate GUI width
    const guiWidth = fretCount * FRET_SPACING + FRET_SPACING; // Max frets * spacing + 1 additional space for Fret 0
    fretboardGui.style.minWidth = `${guiWidth}px`;

    // Draw Frets (Vertical Lines)
    for (let f = 0; f <= fretCount; f++) {
        const fretPos = f * FRET_SPACING;
        const fretEl = document.createElement('div');
        fretEl.className = 'fret';
        fretEl.style.left = `${fretPos}px`;
        fretEl.style.width = '1px';
        
        if (f > 0) {
            fretEl.style.transform = 'translateX(-1px)';
        } else {
            fretEl.style.borderLeft = '6px solid #aaa'; // Nut (Fret 0 marker)
            fretEl.style.left = '0';
            fretEl.style.zIndex = '50';
        }
        fretboardGui.appendChild(fretEl);

        // Fret Markers (Dots)
        const midPointY = (30 + (numStrings - 1) * STRING_PITCH_GAP + 30) / 2; // Midpoint between first and last string
        if ([3, 5, 7, 9, 15].includes(f) && f <= fretCount) {
            const marker = document.createElement('div');
            marker.className = 'fret-marker';
            marker.style.left = `${fretPos + (FRET_SPACING / 2)}px`; 
            marker.style.top = `${midPointY}px`;
            fretboardGui.appendChild(marker);
        }
        if (f === 12 && f <= fretCount) {
            const marker1 = document.createElement('div');
            marker1.className = 'fret-marker';
            marker1.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
            marker1.style.top = `${midPointY - STRING_PITCH_GAP}px`;
            fretboardGui.appendChild(marker1);

            const marker2 = document.createElement('div');
            marker2.className = 'fret-marker';
            marker2.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
            marker2.style.top = `${midPointY + STRING_PITCH_GAP}px`;
            fretboardGui.appendChild(marker2);
        }

        // Fret Number Label
        const numLabel = document.createElement('div');
        numLabel.className = 'fret-number';
        
        if (f === 0) {
            numLabel.textContent = '0';
            numLabel.style.left = `${FRET_SPACING / 2}px`; 
            fretboardGui.appendChild(numLabel);
        } else if (f <= fretCount) {
            numLabel.textContent = f;
            numLabel.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
            fretboardGui.appendChild(numLabel);
        }
    }
    
    // Draw Strings and Notes
    
    // Determine string order for rendering
    let orderedStrings = [...fretboardData];
    if (handedness === 'right') {
        // RIGHT-HANDED: Player View (Thinnest string on top, Thickest string on bottom)
        orderedStrings.sort((a, b) => a.thickness - b.thickness);
    } else {
        // LEFT-HANDED: Mirrored View (Thickest string on top, Thinnest string on bottom)
        orderedStrings.sort((a, b) => b.thickness - a.thickness);
    }

    // Find the maximum thickness to normalize string heights
    const maxThickness = orderedStrings.reduce((max, s) => Math.max(max, s.thickness), 0);
    
    orderedStrings.forEach((stringData, stringIndex) => {
        // String vertical position
        const stringY = 30 + stringIndex * STRING_PITCH_GAP; 

        // String wire
        const stringEl = document.createElement('div');
        stringEl.className = 'string';
        stringEl.style.top = `${stringY}px`;
        
        const lineHeight = 1 + (stringData.thickness / maxThickness) * 2; 
        stringEl.style.height = `${lineHeight}px`; 
        
        fretboardGui.appendChild(stringEl);

        // String label (open note name)
        const labelEl = document.createElement('div');
        labelEl.className = 'string-label';
        labelEl.textContent = stringData.open_note_name;
        labelEl.style.top = `${stringY}px`;
        fretboardGui.appendChild(labelEl);

        // Place notes (dots)
        stringData.cells.forEach(cell => {
            if (cell.is_scale && cell.fret >= 0) {
                const dotEl = document.createElement('div');
                dotEl.className = `fret-dot ${cell.is_root ? 'root' : 'scale'}`;
                
                // Use showNotes to determine content
                const dotContent = showNotes ? cell.name.split('/')[0] : (cell.is_root ? 'R' : '');
                dotEl.textContent = dotContent;

                let xPos;
                const dotSize = 24; // 1.5rem

                if (cell.fret === 0) {
                     xPos = (FRET_SPACING / 2);
                } else {
                    xPos = (cell.fret * FRET_SPACING) + (FRET_SPACING / 2);
                }

                dotEl.style.left = `${xPos}px`;
                dotEl.style.top = `${stringY}px`;
                
                const isDroneString = instrumentKey.includes('Banjo') && stringData.string_index === 5;
                if (isDroneString && cell.fret > 5) return;

                fretboardGui.appendChild(dotEl);
            }
        });
    });

    const guiWrapper = document.createElement('div');
    guiWrapper.className = 'fretboard-container';
    guiWrapper.appendChild(fretboardGui);
    
    return guiWrapper;
}

function renderTable1(fretboardData, rootName, modeName, showNotes) {
    // Orientation 1: Strings as Rows (Thin to Thick, top to bottom)
    const fretCount = fretboardData[0].cells.length - 1;

    // Sort data: Thin (top row) to Thick (bottom row)
    let orderedStrings = [...fretboardData].sort((a, b) => a.thickness - b.thickness);

    let html = `<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Strings as Rows (Thinnest String at Top)</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">String</th>
                        ${Array.from({ length: fretCount + 1 }, (_, i) => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Fret ${i}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${orderedStrings.map(stringData => {
                        const stringLabel = `${stringData.label} (${stringData.open_note_name})`;
                        return `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stringLabel}</td>
                            ${stringData.cells.map(note => {
                                const isRoot = note.is_root;
                                const isScale = note.is_scale && !isRoot;
                                let classes = 'px-2 py-4 whitespace-nowrap text-center text-sm font-bold';
                                if (isRoot) {
                                    classes += ' bg-red-100 text-red-800 rounded-lg';
                                } else if (isScale) {
                                    classes += ' bg-indigo-100 text-indigo-800 rounded-lg';
                                } else {
                                    classes += ' text-gray-400';
                                }
                                const display = showNotes ? (note.is_scale ? note.name : '-') : (note.is_scale ? (isRoot ? 'R' : 'X') : '-');
                                return `<td class="${classes}">${display}</td>`;
                            }).join('')}
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
    return html;
}

function renderTable2(fretboardData, rootName, modeName, handedness, showNotes) {
    // Orientation 2: Frets as Rows (Transposed - Handedness Specific)
    const fretCount = fretboardData[0].cells.length - 1;

    // Determine column order based on handedness
    let stringsToRender = [...fretboardData];
    if (handedness === 'right') {
        // Right-Handed: Thickest (Left) to Thinnest (Right)
        stringsToRender.sort((a, b) => b.thickness - a.thickness);
    } else {
        // Left-Handed: Thinnest (Left) to Thickest (Right)
        stringsToRender.sort((a, b) => a.thickness - b.thickness);
    }

    // Headers (Strings)
    const stringHeaders = stringsToRender.map(s => `${s.label} (${s.open_note_name})`);
    
    let html = `<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Frets as Rows (Fretboard Map)</h3>
        <p class="text-sm text-gray-500 mb-4">String order reflects the player's perspective (${handedness}-handed).</p>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fret</th>
                        ${stringHeaders.map(label => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${label}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${Array.from({ length: fretCount + 1 }, (_, f) => {
                        return `<tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Fret ${f}</td>
                            ${stringsToRender.map(stringData => {
                                const note = stringData.cells[f];
                                const isRoot = note.is_root;
                                const isScale = note.is_scale && !isRoot;
                                let classes = 'px-2 py-4 whitespace-nowrap text-center text-sm font-bold';
                                if (isRoot) {
                                    classes += ' bg-red-100 text-red-800 rounded-lg';
                                } else if (isScale) {
                                    classes += ' bg-indigo-100 text-indigo-800 rounded-lg';
                                } else {
                                    classes += ' text-gray-400';
                                }
                                const display = showNotes ? (note.is_scale ? note.name : '-') : (note.is_scale ? (isRoot ? 'R' : 'X') : '-');
                                return `<td class="${classes}">${display}</td>`;
                            }).join('')}
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        </div>
    </div>`;
    return html;
}

// --- NEW: TABLATURE PLAYBACK LOGIC (Part VII) ---

/**
 * Parses the transposed tab data into an array of events for Tone.js.
 * @param {object} transposedTab - The tab object, e.g., { e4: ['0', '1', '-'], ... }
 * @param {object} stringDataMap - Map of string data for note calculation.
 * @param {number} tempo - The BPM for playback.
 * @returns {Array} An array of playable events for Tone.Part.
 */
function parseTabToPlayableEvents(transposedTab, stringDataMap, tempo) {
    const playableEvents = [];
    const timePerBeat = 60 / tempo / 4; // Time for one 16th note
    const noteDuration = "16n";

    const stringNames = Object.keys(transposedTab);
    if (stringNames.length === 0) return [];

    const totalNotes = transposedTab[stringNames[0]].length;

    for (let i = 0; i < totalNotes; i++) { // Iterate through each time step (16th note)
        for (const stringFullName of stringNames) { // e.g., 'e4', 'B3'
            const fret = transposedTab[stringFullName][i];

            // Check for a playable note
            if (fret !== '-' && fret !== '?' && fret !== undefined) {
                const stringData = stringDataMap[stringFullName];
                if (!stringData) continue;

                // a. Calculate time
                const time = i * timePerBeat;

                // b. Calculate note name using Tonal.js
                const baseMidi = Tonal.Note.midi(stringData.open_note_name);
                if (baseMidi === undefined) continue;

                const noteMidi = baseMidi + parseInt(fret, 10);
                const noteName = Tonal.Note.fromMidi(noteMidi);

                // c. Add the event object
                playableEvents.push({
                    time: time,
                    note: noteName,
                    duration: noteDuration
                });
            }
        }
    }
    return playableEvents;
}

/**
 * Plays the parsed tablature using Tone.js.
 * @param {Array} playableEvents - The array of note objects from the parser.
 */
async function playTablature(playableEvents) {
    if (playableEvents.length === 0) {
        console.log("No notes to play.");
        return;
    }

    await Tone.start(); // Ensure AudioContext is running
    stopTablature(); // Stop any previous playback

    currentTabPart = new Tone.Part((time, event) => {
        synth.triggerAttackRelease(event.note, event.duration, time);
    }, playableEvents).start(0);

    Tone.Transport.start();
}

/**
 * Stops the tablature playback.
 */
function stopTablature() {
    Tone.Transport.stop();
    Tone.Transport.cancel();
    if (currentTabPart) {
        currentTabPart.dispose();
        currentTabPart = null;
    }
}

function initializeAccordions() {
    const accordions = document.querySelectorAll('.accordion-container');
    accordions.forEach(accordion => {
        const header = accordion.querySelector('.accordion-header');
        const content = accordion.querySelector('.accordion-content');
        const symbol = header.querySelector('.accordion-symbol');

        header.addEventListener('click', () => {
            const isVisible = content.style.display === 'block';
            content.style.display = isVisible ? 'none' : 'block';
            symbol.textContent = isVisible ? '+' : '-';
        });
    });
}

function initializeControls() {
    const instrumentSelect = document.getElementById('instrumentFilter');
    const rootSelect = document.getElementById('rootSelect');
    const modeSelect = document.getElementById('modeSelect');
    const generateBtn = document.getElementById('generate-btn');

    // Populate Instruments
    for (const key in TUNINGS) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = TUNINGS[key].name;
        instrumentSelect.appendChild(option);
    }

    // Populate Root Notes
    const rootOptions = getRootOptions();
    for (const name in rootOptions) {
        const option = document.createElement('option');
        option.value = rootOptions[name];
        option.textContent = name;
        rootSelect.appendChild(option);
    }

    // Populate Scales/Modes
    for (const category in SCALES) {
        const optgroup = document.createElement('optgroup');
        optgroup.label = category;
        for (const scale of SCALES[category]) {
            const option = document.createElement('option');
            option.value = scale.intervals.join(',');
            option.textContent = scale.name;
            optgroup.appendChild(option);
        }
        modeSelect.appendChild(optgroup);
    }

    const generate = () => {
        const instrumentKey = instrumentSelect.value;
        const rootIndex = parseInt(rootSelect.value, 10);
        const scaleIntervals = modeSelect.value.split(',').map(Number);
        const handedness = document.getElementById('handedness').value;
        const showNotes = document.getElementById('show-notes').checked;
        const orientation = document.querySelector('input[name="orientation"]:checked').value;

        const fretboardData = buildInstrumentData(instrumentKey, rootIndex, scaleIntervals);
        const outputDiv = document.getElementById('fretboard-output');
        outputDiv.innerHTML = ''; // Clear previous output

        // Add the GUI fretboard
        const gui = renderGui(fretboardData, instrumentKey, handedness, showNotes);
        outputDiv.appendChild(gui);


        if (orientation === 'both' || orientation === '1') {
            const table1 = renderTable1(fretboardData, rootSelect.options[rootSelect.selectedIndex].text, modeSelect.options[modeSelect.selectedIndex].text, showNotes);
            outputDiv.innerHTML += table1;
        }
        if (orientation === 'both' || orientation === '2') {
            const table2 = renderTable2(fretboardData, rootSelect.options[rootSelect.selectedIndex].text, modeSelect.options[modeSelect.selectedIndex].text, handedness, showNotes);
            outputDiv.innerHTML += table2;
        }
    };

    generateBtn.addEventListener('click', generate);
    instrumentSelect.addEventListener('change', generate);
    rootSelect.addEventListener('change', generate);
    modeSelect.addEventListener('change', generate);
    document.getElementById('handedness').addEventListener('change', generate);
    document.getElementById('show-notes').addEventListener('change', generate);
    document.querySelectorAll('input[name="orientation"]').forEach(radio => {
        radio.addEventListener('change', generate);
    });

    generate(); // Initial generation
}


window.onload = async () => {
    // await loadChordShapes(); // Load chord data first - This function does not exist
    initializeControls(); // Setup controls and run initial generation
    // initializeKeyHarmonySection(); // Setup the interactive harmony section - This function does not exist
    initializeAccordions(); // Initialize all accordion elements
};
