<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fretboard Training Manuscripts</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tonal/browser/tonal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svguitar/dist/svguitar.js"></script>
    <script src="database.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding: 10px;
        }
        .container {
            max-width: 100%;
            margin: auto;
            padding: 10px;
        }
        .control-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        @media (min-width: 640px) {
            .control-group {
                /* Use 4-column layout like the original file for better alignment */
                grid-template-columns: repeat(4, 1fr);
            }
        }
        select, button, input[type="number"] {
            border-radius: 0.5rem;
            padding: 8px 12px;
            font-size: 1rem;
            border: 1px solid #D1D5DB; /* Added border for inputs */
        }
        
        /* Fretboard GUI Styles from New File */
        .fretboard-container {
            position: relative;
            overflow-x: auto; /* Use auto for scrollbars only when needed */
            margin-top: 15px;
            margin-bottom: 30px;
            padding-bottom: 30px; /* Increased padding for numbers */
            background-color: #5d4037; /* Fretboard wood color (from original file) */
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .fretboard-gui {
            position: relative;
            min-width: 1200px; /* Ensures enough room for 15 frets at 75px spacing */
            padding-top: 25px; /* Increased vertical padding */
            padding-bottom: 50px;
            margin-left: 60px; /* Space for string names */
        }
        .fret {
            position: absolute;
            height: 100%;
            border-left: 2px solid #c0c0c0; /* Fret wire color (from original file) */
            z-index: 10;
        }
        .string {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #ccc; /* String color (from original file) */
            z-index: 20;
        }
        .fret-dot {
            position: absolute;
            width: 1.5rem; /* 24px (from original file) */
            height: 1.5rem; /* 24px (from original file) */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* 12px (from original file) */
            font-weight: bold;
            color: white;
            z-index: 30;
            opacity: 0.9;
            transition: opacity 0.2s;
            transform: translate(-50%, -50%); /* Use transform for centering */
        }
        .fret-dot.root {
            background-color: #e53e3e; /* Root color (from original file) */
            border: 2px solid #fff;
            box-shadow: 0 0 5px rgba(229, 62, 62, 0.8);
        }
        .fret-dot.scale {
            background-color: #3182ce; /* Scale color (from original file) */
        }
        .fret-number {
            position: absolute;
            bottom: -25px;
            left: 0;
            font-size: 0.9rem; /* Larger fret numbers */
            color: #ccc;
            text-align: center;
            width: 75px; /* Matches FRET_SPACING */
            transform: translateX(-50%);
        }
        .fret-marker {
            position: absolute;
            width: 0.75rem;
            height: 0.75rem;
            background-color: #d1d5db;
            border-radius: 50%;
            z-index: 15;
            transform: translate(-50%, -50%); /* Center the marker */
        }
        .string-label {
            position: absolute;
            left: -50px;
            font-size: 0.9rem;
            color: #ddd;
            white-space: nowrap;
            transform: translateY(-50%); /* Vertically center label on string */
        }

        /* NEW: Interactive Key & Harmony Section Styles */
        .key-harmony-section {
            background-color: #f8fafc; /* Lighter gray */
            border-top: 4px solid #6366f1; /* Indigo */
        }
        .circle-of-fifths {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 2rem auto;
        }
        .key-button {
            position: absolute;
            width: 60px;
            height: 60px;
            background-color: #fff;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .key-button:hover {
            transform: scale(1.1);
            border-color: #4f46e5;
            color: #4f46e5;
        }
        .key-button.active {
            background-color: #4f46e5;
            color: #fff;
            border-color: #4f46e5;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
        }
        .diatonic-chord-btn {
            transition: all 0.2s ease-in-out;
        }
        .diatonic-chord-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.4);
        }
        #chord-display-container {
            min-height: 300px;
        }

        /* NEW: Accordion Styles for Fundamentals Library */
        .accordion-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #4b5563;
            transition: background-color 0.2s;
        }
        .accordion-header:hover {
            background-color: #e5e7eb;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #fafafa;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .accordion-content p {
            padding: 1rem;
            margin: 0;
        }
        .accordion-symbol {
            font-weight: bold;
            transition: transform 0.3s;
        }
        .accordion-header.active .accordion-symbol {
            transform: rotate(45deg);
        }


        /* Tablature Custom Styling (from original file) */
        .tab-staff-line {
            display: flex;
            align-items: center;
        }
        .tab-string-content {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #9ca3af; /* String line color */
            min-width: max-content; /* Prevent wrapping */
        }
        .tab-staff-line:last-child .tab-string-content {
             border-bottom-width: 2px; /* Thicker line for the lowest string */
             border-color: #4b5563;
        }
        .tab-fret-cell {
            display: inline-block;
            width: 1.5rem; /* Standard width for 1-2 characters */
            text-align: center;
            padding: 0 0.125rem;
            height: 1.5rem; /* Ensure consistent height */
            line-height: 1.5rem; /* Center text vertically */
        }
        /* NEW: Class for 8th note rests */
        .fret-dot.rest {
            color: #cbd5e1; /* Lighter gray for 8th note rests */
        }
        .tab-separator {
            width: 0.5rem;
            text-align: center;
            font-weight: bolder;
        }
        /* NEW: Wrapper for each visual bar of tab */
        .tab-bar {
            margin-bottom: 1.5rem; /* Space between wrapped bars */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto container">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-800">The Fretboard Training Manuscripts</h1>
            <p class="text-lg text-gray-600 mt-2">Visualize scales, modes, and find practical examples.</p>
        </header>

        <!-- Controls Section (Merged Layout) -->
        <div class="bg-white p-6 rounded-xl shadow-2xl mb-10 border-t-8 border-indigo-500">
            <div class="control-group">
                <label class="block">
                    <span class="text-gray-700 font-semibold">Instrument</span>
                    <select id="instrumentFilter" class="mt-1 block w-full border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <!-- Options will be populated by JS -->
                    </select>
                </label>
                <label class="block">
                    <span class="text-gray-700 font-semibold">Root Note</span>
                    <select id="rootSelect" class="mt-1 block w-full border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <!-- Options will be populated by JS -->
                    </select>
                </label>
                <label class="block">
                    <span class="text-gray-700 font-semibold">Scale/Mode</span>
                    <select id="modeSelect" class="mt-1 block w-full border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <!-- Options will be populated by JS -->
                    </select>
                </label>
                <label class="block">
                    <span class="text-gray-700 font-semibold">Handedness</span>
                    <select id="handedness" class="mt-1 block w-full border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="right">Right-Handed</option>
                        <option value="left">Left-Handed</option>
                    </select>
                </label>
            </div>

            <div class="mt-6 flex flex-wrap gap-x-6 gap-y-4 items-center">
                <span class="text-gray-700 font-semibold">Orientation:</span>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="orientation" value="both" id="orientation-both" checked class="form-radio text-indigo-600">
                    <span class="text-gray-700">Both Tables</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="orientation" value="1" id="orientation-1" class="form-radio text-indigo-600">
                    <span class="text-gray-700">Strings as Rows</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="radio" name="orientation" value="2" id="orientation-2" class="form-radio text-indigo-600">
                    <span class="text-gray-700">Frets as Rows</span>
                </label>
                <label class="flex items-center space-x-2 ml-6">
                    <input type="checkbox" id="show-notes" checked class="form-checkbox text-indigo-600 rounded">
                    <span class="text-gray-700">Show Note Names</span>
                </label>
            </div>

            <!-- UPDATED: Tablature Formatting Controls -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">Tablature Training Settings</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Beats/Measure</span>
                        <input type="number" id="beats-per-measure" value="4" min="1" max="8" class="mt-1 block w-full shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Measures/Bar (Wrap)</span>
                        <input type="number" id="measures-per-bar" value="4" min="1" max="8" class="mt-1 block w-full shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Tempo (BPM)</span>
                        <input type="number" id="tab-tempo" value="120" min="40" max="240" class="mt-1 block w-full shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 font-semibold">Note Division</span>
                        <select id="note-division" class="mt-1 block w-full border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option value="16">16th Notes</option>
                            <option value="8">8th Notes (Show 1st/3rd)</option>
                        </select>
                    </label>
                </div>
            </div>

            <!-- NEW: Fundamentals Accordion -->
            <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
                <div class="accordion-container">
                    <div class="accordion-header">
                        <span>[+] What is a Scale?</span>
                        <span class="accordion-symbol">+</span>
                    </div>
                    <div class="accordion-content">
                        <p class="text-gray-700 text-sm">A scale is a set of musical notes ordered by pitch. In this tool, we define scales by their intervals from a starting "root note". For example, the Major Scale has the interval pattern: Root, Major 2nd, Major 3rd, Perfect 4th, Perfect 5th, Major 6th, and Major 7th.</p>
                    </div>
                </div>
                <div class="accordion-container">
                    <div class="accordion-header">
                        <span>[+] What are the Minor Scales?</span>
                        <span class="accordion-symbol">+</span>
                    </div>
                    <div class="accordion-content">
                        <p class="text-gray-700 text-sm">There are several types of minor scales. The <strong>Natural Minor</strong> (or Aeolian mode) is the most common. The <strong>Harmonic Minor</strong> features a raised 7th degree, creating a larger step at the end of the scale that gives it a distinct sound. The <strong>Melodic Minor</strong> raises both the 6th and 7th degrees when ascending to create a smoother melody line.</p>
                    </div>
                </div>
            </div>


            <div class="mt-8">
                <button id="generate-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.005]">
                    Generate Fretboard
                </button>
            </div>
        </div>

        <!-- NEW: Interactive Key & Harmony Section -->
        <div id="key-harmony-container" class="key-harmony-section p-6 md:p-8 rounded-xl shadow-2xl mb-10">
            <h2 class="text-3xl font-bold text-indigo-700 mb-2 text-center">Interactive Key & Harmony</h2>
            <p class="text-center text-gray-600 mb-8">Select a key to see its diatonic chords and common progressions.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                <!-- Circle of Fifths -->
                <div class="md:col-span-1 flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">1. Select a Key</h3>
                    <div class="circle-of-fifths">
                        <!-- Key buttons will be populated by JS -->
                    </div>
                </div>

                <!-- Diatonic Chords & Progressions -->
                <div class="md:col-span-2">
                    <div id="diatonic-chords-container" class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">2. Diatonic Chords & Progressions</h3>
                        <div id="diatonic-chords-display" class="flex flex-wrap gap-3 mb-6">
                            <!-- Diatonic chord buttons will be populated here -->
                        </div>
                        <div id="chord-progression-display" class="p-4 bg-gray-100 rounded-lg space-y-2">
                            <!-- Common progressions will be populated here -->
                        </div>
                        <!-- NEW: Fundamentals Accordion -->
                        <div class="mt-4 accordion-container">
                            <div class="accordion-header">
                                <span>[+] What is a Chord and a Triad?</span>
                                <span class="accordion-symbol">+</span>
                            </div>
                            <div class="accordion-content">
                                <p class="text-gray-700 text-sm">A <strong>chord</strong> is three or more notes played simultaneously. The most basic type of chord is a <strong>triad</strong>, which is built using the 1st (Root), 3rd, and 5th notes of a scale. A <strong>Major Triad</strong> uses a Major 3rd, while a <strong>Minor Triad</strong> uses a Minor 3rd, giving them their distinct happy or sad sound.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chord Diagram Display -->
                    <div id="chord-diagram-section">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">3. Chord Diagram</h3>
                        <div id="chord-display-container" class="p-4 bg-white rounded-lg shadow-inner flex justify-center items-center border border-gray-200">
                            <p class="text-gray-500 italic">Select a chord to display its diagram.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Output Section -->
        <div id="fretboard-output" class="space-y-8">
            <p id="placeholder" class="text-center text-xl text-gray-500 italic p-6 border rounded-lg bg-indigo-50">
                Select a Root Note and a Scale/Mode above to generate the fretboard charts and tablature example.
            </p>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const FRET_SPACING = 75; // Standard width for each fret segment in the GUI (in px)
        const STRING_PITCH_GAP = 40; // Vertical gap between strings (in px)
        const NUM_FRETS = 15; // Use a global fret count

        // --- DATA DEFINITIONS ---

        const CHROMATIC_NOTES = [
            { name: "C", aliases: [] },
            { name: "C♯", aliases: ["D♭"] },
            { name: "D", aliases: [] },
            { name: "D♯", aliases: ["E♭"] },
            { name: "E", aliases: [] },
            { name: "F", aliases: [] },
            { name: "F♯", aliases: ["G♭"] },
            { name: "G", aliases: [] },
            { name: "G♯", aliases: ["A♭"] },
            { name: "A", aliases: [] },
            { name: "A♯", aliases: ["B♭"] },
            { name: "B", aliases: [] }
        ];

        // --- SECTION 1: CORRECTED CONSTANTS (from C_Major_Guitar_Tab_sequential.csv) ---
        
        const NOTES_PER_BEAT = 4; // 16th notes
        const DEFAULT_BEATS_PER_MEASURE = 4; // 4/4 time
        const DEFAULT_NOTES_PER_MEASURE = DEFAULT_BEATS_PER_MEASURE * NOTES_PER_BEAT; // 16
        
        // --- FIX: Updated totals based on the full CSV data (C_Major_Guitar_Tab_sequential.csv) ---
        const TOTAL_MEASURES = 32;
        const TOTAL_DEFAULT_NOTES = 512;
        // --- END SECTION 1 ---
        

        // --- SECTION 2: CORRECTED C_MAJOR_BASE_TAB (from C_Major_Guitar_Tab_sequential.csv) ---
        // This 6-string guitar tab is left as-is, per user request.
        const C_MAJOR_BASE_TAB = {
            'e4': [
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M6
                '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','10','12', // M13
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
                '0','-','-','-','-','1','3','-','-','-','-','0','1','-','-','3', // M15
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
                '-','-','3','2','-','-','-','-','1','0','-','-','-','-','-','-', // M17
                '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M18
                '-','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M19
                '2','2','-','-','4','4','-','-','1','1','-','-','4','-','-','-', // M20
                '-','-','-','-','4','-','4','-','2','-','2','-','-','-','-','0', // M21
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M22
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','4', // M23
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','0', // M24
                '3','1','0','-','-','-','-','-','-','-','-','-','-','-','-','-', // M25
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','5', // M26
                '8','7','5','-','-','-','-','-','-','-','-','-','-','-','-','-', // M27
                '-','-','-','-','-','-','-','-','-','-','-','-','-','10','12','13', // M28
                '13','12','10','-','-','-','-','-','-','-','-','-','-','-','-','-', // M29
                '-','-','-','-','-','-','-','-','-','-','3','1','-','2','-','-', // M30
                '-','-','2','-','1','3','-','-','-','-','-','-','-','-','-','-', // M31
                '12','10','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M32
            ],
            'B3': [
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M8
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
                '-','-','-','-','-','-','-','-','-','-','-','-','8','10','-','-', // M13
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
                '-','1','-','-','3','-','-','0','-','-','3','-','-','3','1','-', // M15
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
                '-','1','-','-','3','-','-','0','-','-','3','-','-','3','1','-', // M17
                '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M18
                '2','2','-','-','4','4','-','-','1','1','-','-','2','-','-','-', // M19
                '3','-','3','-','5','-','5','-','1','-','1','-','-','5','3','-', // M20
                '1','-','1','-','5','-','-','5','3','-','-','3','-','-','3','3', // M21
                '-','-','-','-','-','-','-','-','1','-','1','-','-','-','-','3', // M22
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','4','4', // M23
                '-','-','-','-','-','-','-','-','-','-','-','-','0','1','3','-', // M24
                '-','-','-','3','1','0','-','-','-','-','-','-','-','-','-','-', // M25
                '-','-','-','-','-','-','-','-','-','-','-','-','5','6','8','-', // M26
                '-','-','-','8','6','5','-','-','-','-','-','-','-','-','-','-', // M27
                '-','-','-','-','-','-','-','-','-','-','10','12','13','-','-','-', // M28
                '-','-','-','13','12','10','-','-','-','-','-','-','-','-','-','-', // M29
                '-','-','10','8','6','5','6','5','4','2','3','1','-','3','1','-', // M30
                '-','1','3','-','1','3','2','4','5','6','5','6','8','10','-','-', // M31
                '-','-','10','8','-','-','-','-','-','-','-','-','-','-','-','-', // M32
            ],
            'G3': [
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '0','2','0','4','2','4','2','0','4','0','2','0','4','0','4','2', // M4
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
                '4','2','4','0','2','0','2','4','2','4','2','0','2','4','2','4', // M9
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
                '-','-','-','-','-','-','-','-','-','5','7','9','-','-','-','-', // M13
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M14
                '-','-','4','2','-','-','-','-','2','0','-','-','-','-','-','-', // M15
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M16
                '0','-','-','-','-','1','3','-','-','-','-','0','2','-','-','4', // M17
                '1','1','-','-','2','2','-','-','0','0','-','-','-','-','-','-', // M18
                '2','-','2','-','4','-','4','-','0','-','0','-','-','2','4','-', // M19
                '2','-','-','2','4','-','-','4','2','-','-','2','-','-','-','2', // M20
                '2','-','-','2','4','4','-','-','2','2','-','-','-','2','-','2', // M21
                '0','-','0','-','4','-','4','-','0','-','-','0','-','-','2','2', // M22
                '-','-','-','-','-','-','-','-','1','-','1','-','-','2','-','2', // M23
                '-','-','-','-','-','-','-','-','-','0','2','4','-','-','-','-', // M24
                '-','-','-','-','-','-','4','2','0','-','-','-','-','-','-','-', // M25
                '-','-','-','-','-','-','-','-','-','5','7','9','-','-','-','-', // M26
                '-','-','-','-','-','-','7','5','-','-','-','-','-','-','-','-', // M27
                '-','-','-','-','-','-','-','9','10','12','-','-','-','-','-','-', // M28
                '-','-','-','-','-','-','12','10','9','-','-','-','-','-','-','-', // M29
                '10','9','9','7','5','4','5','4','3','2','0','2','1','2','0','3', // M30
                '3','0','2','1','2','0','2','3','4','5','4','5','7','9','9','10', // M31
                '-','-','-','-','9','7','5','-','-','-','-','-','-','-','-','-', // M32
            ],
            'D3': [
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                '0','2','0','3','2','3','2','0','3','0','2','0','3','0','3','2', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
                '3','2','3','0','2','0','2','3','2','3','2','0','2','3','2','3', // M10
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
                '-','-','-','-','-','-','3','5','7','-','-','-','-','-','-','-', // M13
                '-','-','3','2','-','-','-','-','2','0','-','-','-','-','-','-', // M14
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
                '0','-','-','-','-','2','3','-','-','-','-','0','2','-','-','3', // M16
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
                '2','-','2','-','3','-','3','-','0','-','0','-','2','-','-','-', // M18
                '2','-','-','2','4','-','-','4','2','-','-','2','-','-','-','4', // M19
                '0','-','-','-','2','-','-','-','3','-','-','-','-','-','-','-', // M20
                '3','3','-','-','-','-','-','-','-','-','-','-','3','-','-','3', // M21
                '2','-','-','2','4','-','-','4','2','2','-','-','-','2','-','2', // M22
                '2','-','2','-','3','-','3','-','0','-','-','0','2','-','-','2', // M23
                '-','-','-','-','-','-','0','2','3','-','-','-','-','-','-','-', // M24
                '-','-','-','-','-','-','-','-','-','-','-','-','3','2','0','-', // M25
                '-','-','-','-','-','-','5','7','9','-','-','-','-','-','-','-', // M26
                '-','-','-','-','-','-','-','-','7','5','-','-','-','-','-','-', // M27
                '-','-','-','-','9','10','12','-','-','-','-','-','-','-','-','-', // M28
                '-','-','-','-','-','-','-','-','-','12','10','9','-','-','-','-', // M29
                '10','9','7','5','7','6','7','5','4','2','0','3','2','0','2','4', // M30
                '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
                '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
            ],
            'A2': [
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '0','2','0','3','2','3','2','0','3','0','2','0','3','0','3','2', // M2
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
                '3','2','3','0','2','0','2','3','2','3','2','0','2','3','2','3', // M11
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M12
                '-','-','-','2','3','5','-','-','-','-','-','-','-','-','-','-', // M13
                '-','2','-','-','3','-','-','0','-','-','3','-','-','3','2','-', // M14
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
                '-','2','-','-','3','-','-','0','-','-','3','-','-','3','2','-', // M16
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
                '2','-','-','2','3','-','-','3','2','-','-','2','-','3','2','-', // M18
                '0','-','-','-','2','-','-','-','3','-','-','-','-','-','-','-', // M19
                '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M20
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','0', // M21
                '3','3','-','-','2','2','-','-','-','-','-','-','3','-','-','3', // M22
                '3','-','-','3','3','-','-','3','2','2','-','-','-','-','-','-', // M23
                '-','-','-','0','2','3','-','-','-','-','-','-','-','-','-','-', // M24
                '-','-','-','-','-','-','-','-','-','-','-','-','3','2','0','-', // M25
                '-','-','-','-','-','-','5','7','8','-','-','-','-','-','-','-', // M26
                '-','-','-','-','-','-','-','-','-','-','8','7','5','-','-','-', // M27
                '-','-','10','12','-','-','-','-','-','-','-','-','-','-','-','-', // M28
                '-','-','-','-','-','-','-','-','-','-','-','-','12','10','-','-', // M29
                '12','11','8','6','8','7','5','3','2','0','-','-','2','-','3','4', // M30
                '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
                '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
            ],
            'E2': [
                '0','1','0','3','1','3','1','0','3','0','1','0','3','0','3','1', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M9
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M10
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M11
                '3','1','3','0','1','0','1','3','1','3','1','0','1','3','1','3', // M12
                '0','1','3','-','-','-','-','-','-','-','-','-','-','-','-','-', // M13
                '0','-','-','-','-','1','3','-','-','-','-','0','1','-','-','3', // M14
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M15
                '-','-','3','1','-','-','-','-','1','0','-','-','-','-','-','-', // M16
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M17
                '0','-','-','-','1','-','-','-','3','-','-','-','-','-','-','3', // M18
                '-','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M19
                '-','-','-','-','-','-','-','-','1','-','-','-','-','-','-','-', // M20
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M21
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M22
                '3','3','-','-','1','1','-','-','-','-','-','-','-','-','-','-', // M23
                '0','1','3','-','-','-','-','-','-','-','-','-','-','-','-','-', // M24
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','3', // M25
                '5','7','8','-','-','-','-','-','-','-','-','-','-','-','-','-', // M26
                '-','-','-','-','-','-','-','-','7','5','-','-','-','-','-','-', // M27
                '-','-','-','-','9','10','12','-','-','-','-','-','-','-','-','-', // M28
                '-','-','-','-','-','-','-','-','-','12','10','9','-','-','-','-', // M29
                '12','11','8','6','8','7','5','3','2','0','-','-','2','-','3','4', // M30
                '4','3','-','2','-','-','0','2','3','5','7','8','6','8','11','12', // M31
                '-','-','-','-','-','-','-','-','-','-','5','3','2','-','-','-', // M32
            ],
        };
        // --- END SECTION 2 ---


        // --- SECTION 3: C_MAJOR_BASE_NOTE_MAP (6-String Guitar) ---
        // This map is left as-is, per user request.
        const C_MAJOR_BASE_NOTE_MAP = {
            'e4': { '0': 4, '1': 5, '2': 6, '3': 7, '4': 8, '5': 9, '7': 11, '8': 12, '10': 14, '12': 16, '13': 17 },
            'B3': { '0': 11, '1': 12, '2': 13, '3': 14, '4': 15, '5': 16, '6': 17, '8': 19, '10': 21, '12': 23, '13': 24 },
            'G3': { '0': 7, '1': 8, '2': 9, '3': 10, '4': 11, '5': 12, '7': 14, '9': 16, '10': 17, '12': 19 },
            'D3': { '0': 2, '2': 4, '3': 5, '4': 6, '5': 7, '6': 8, '7': 9, '9': 11, '10': 12, '12': 14 },
            'A2': { '0': 9, '2': 11, '3': 12, '4': 13, '5': 14, '6': 15, '7': 16, '8': 17, '10': 19, '11': 20, '12': 21 },
            'E2': { '0': 4, '1': 5, '2': 6, '3': 7, '5': 9, '7': 11, '8': 12, '10': 14, '12': 16, '13': 17 },
        };
        // --- END SECTION 3 ---

        const C_MAJOR_ROOT_INDEX = 0; // C = 0


        // --- RE-COMPOSED: 4-STRING BASS CONSTANTS (EADG) ---
        
        const C_MAJOR_BASS_8_MEASURE_LOOP = {
            'G3': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '0','-','2','-','4','-','-','-','-','-','-','-','-','-','-','-', // M7
                '0','-','-','-','4','-','2','-','0','-','-','-','-','-','-','-', // M8
            ],
            'D3': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '2','-','3','-','5','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','5','-','3','-','2','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '-','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M3
                '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '0','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'A2': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '-','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M5
                '-','-','-','-','3','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'E2': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '0','-','1','-','3','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
        };
        // Repeat the 8-measure loop to create the full 32-measure (512-beat) exercise
        const C_MAJOR_BASS_TAB = {
            'G3': [
                ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'],
                ...C_MAJOR_BASS_8_MEASURE_LOOP['G3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['G3']
            ],
            'D3': [
                ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'],
                ...C_MAJOR_BASS_8_MEASURE_LOOP['D3'], ...C_MAJOR_BASS_8_MEASURE_LOOP['D3']
            ],
            'A2': [
                ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'],
                ...C_MAJOR_BASS_8_MEASURE_LOOP['A2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['A2']
            ],
            'E2': [
                ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'],
                ...C_MAJOR_BASS_8_MEASURE_LOOP['E2'], ...C_MAJOR_BASS_8_MEASURE_LOOP['E2']
            ]
        };
        // --- UPDATED: Note map for new playable bass étude ---
        const C_MAJOR_BASS_NOTE_MAP = {
            'G3': { '0': 7, '2': 9, '4': 11, '5': 12 },
            'D3': { '0': 2, '2': 4, '3': 5, '5': 7 },
            'A2': { '3': 12, '5': 14 },
            'E2': { '0': 4, '1': 5, '3': 7 }
        };
        // --- END 4-STRING BASS CONSTANTS ---


        // --- RE-COMPOSED: MANDOLIN CONSTANTS (GDAE) ---
        // --- This loop is 8 measures, repeated 4 times ---
        const C_MAJOR_MANDOLIN_8_MEASURE_LOOP = {
            'E5': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '0','-','1','-','3','-','5','-','5','-','3','-','1','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '0','-','-','-','5','-','-','-','0','-','-','-','5','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '1','-','-','-','5','-','-','-','1','-','-','-','5','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '3','-','-','-','7','-','-','-','3','-','-','-','7','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'A4': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '0','-','2','-','3','-','-','-','3','-','2','-','0','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '2','-','-','-','-','-','-','-','2','-','-','-','-','-','-','-', // M7
                '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M8
            ],
            'D4': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '0','-','2','-','3','-','5','-','5','-','3','-','2','-','0','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '2','-','-','-','-','-','-','-','2','-','-','-','-','-','-','-', // M3
                '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M7
                '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M8
            ],
            'G3': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '5','-','-','-','-','-','-','-','5','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'C2': [
                // C Major Scale (Pos 1) (M1-2) - 8th notes
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M3
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '0','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M8
            ],
        };
        // Repeat the 8-measure loop to create the full 32-measure (512-beat) exercise
        const C_MAJOR_MANDOLIN_TAB = {
            'E5': [
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'],
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['E5']
            ],
            'A4': [
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'],
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['A4']
            ],
            'D4': [
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'],
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['D4']
            ],
            'G3': [
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'],
                ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3'], ...C_MAJOR_MANDOLIN_8_MEASURE_LOOP['G3']
            ]
        };
        // --- UPDATED: Note map for new playable mandolin étude ---
        const C_MAJOR_MANDOLIN_NOTE_MAP = {
            'E5': { '0': 4, '1': 5, '3': 7, '5': 9, '7': 11 },
            'A4': { '0': 9, '2': 11, '3': 12, '5': 14 },
            'D4': { '0': 2, '2': 4, '3': 5, '5': 7 },
            'G3': { '3': 10, '5': 12 } // Corrected G3 to G3
        };
        // --- END MANDOLIN CONSTANTS ---


        // --- RE-COMPOSED: 5-STRING BANJO CONSTANTS (gDGBD) ---
        // --- This loop is 8 measures, repeated 4 times ---
        const C_MAJOR_BANJO_8_MEASURE_LOOP = {
            'G4': [ // High G Drone (String 5)
                // C "Forward Roll" (M1-2)
                '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M1
                '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M2
                // F "Forward Roll" (M3-4)
                '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M3
                '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M4
                // G "Forward Roll" (M5-6)
                '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M5
                '-','-','-','0','-','-','-','0','-','-','-','0','-','-','-','0', // M6
                // C Scale Riff (M7-8) - 8th notes
                '0','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M8
            ],
            'D4': [ // 1st String
                // C "Forward Roll" (M1-2)
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // F "Forward Roll" (M3-4)
                '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M3
                '3','-','-','-','-','-','-','-','3','-','-','-','-','-','-','-', // M4
                // G "Forward Roll" (M5-6)
                '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M5
                '0','-','-','-','-','-','-','-','0','-','-','-','-','-','-','-', // M6
                // C Scale Riff (M7-8) - 8th notes
                '5','-','3','-','1','-','0','-','-','-','-','-','-','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'B3': [ // 2nd String
                // C "Forward Roll" (M1-2)
                '-','-','1','-','-','-','1','-','-','-','1','-','-','-','1','-', // M1
                '-','-','1','-','-','-','1','-','-','-','1','-','-','-','1','-', // M2
                // F "Forward Roll" (M3-4)
                '-','-','3','-','-','-','3','-','-','-','3','-','-','-','3','-', // M3
                '-','-','3','-','-','-','3','-','-','-','3','-','-','-','3','-', // M4
                // G "Forward Roll" (M5-6)
                '-','-','0','-','-','-','0','-','-','-','0','-','-','-','0','-', // M5
                '-','-','0','-','-','-','0','-','-','-','0','-','-','-','0','-', // M6
                // C Scale Riff (M7-8) - 8th notes
                '-','-','-','-','-','-','-','-','3','-','1','-','0','-','-','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'G3': [ // 3rd String
                // C "Forward Roll" (M1-2)
                '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M1
                '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M2
                // F "Forward Roll" (M3-4)
                '-','2','-','-','-','2','-','-','-','2','-','-','-','2','-','-', // M3
                '-','2','-','-','-','2','-','-','-','2','-','-','-','2','-','-', // M4
                // G "Forward Roll" (M5-6)
                '-','0','-','-','-','0','-','-','-','0','-','-','-','-','0','-','-','-','-','-','-','-', // M5
                '-','0','-','-','-','0','-','-','-','0','-','-','-','0','-','-', // M6
                // C Scale Riff (M7-8) - 8th notes
                '0','-','2','-','4','-','5','-','5','-','4','-','2','-','0','-', // M7
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
            'D3': [ // 4th String
                // C "Forward Roll" (M1-2)
                '2','-','-','-','2','-','-','-','2','-','-','-','2','-','-','-', // M1
                '2','-','-','-','2','-','-','-','2','-','-','-','2','-','-','-', // M2
                // F "Forward Roll" (M3-4)
                '3','-','-','-','3','-','-','-','3','-','-','-','3','-','-','-', // M3
                '3','-','-','-','3','-','-','-','3','-','-','-','3','-','-','-', // M4
                // G "Forward Roll" (M5-6)
                '0','-','-','-','0','-','-','-','0','-','-','-','0','-','-','-', // M5
                '0','-','-','-','0','-','-','-','0','-','-','-','0','-','-','-', // M6
                // C Scale Riff (M7-8) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M7
                '5','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
        };
        const C_MAJOR_BANJO_TAB = {
            'G4': [...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G4']],
            'D4': [...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D4']],
            'B3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['B3']],
            'G3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['G3']],
            'D3': [...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3'], ...C_MAJOR_BANJO_8_MEASURE_LOOP['D3']]
        };
        // --- UPDATED: Note map for new playable banjo étude ---
        const C_MAJOR_BANJO_NOTE_MAP = {
            'G4': { '0': 7 }, // Drone string
            'D4': { '0': 2, '1': 3, '3': 5, '5': 7 },
            'B3': { '0': 11, '1': 12, '3': 14 },
            'G3': { '0': 7, '2': 9, '4': 11, '5': 12 },
            'D3': { '0': 2, '2': 4, '3': 5, '5': 7 }
        };
        // --- END 5-STRING BANJO CONSTANTS ---


        // --- RE-COMPOSED: 7-STRING GUITAR CONSTANTS (BEADGBe) ---
        // --- This loop is 8 measures, repeated 4 times ---
        const C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP = {
            'B1': [ 
                // C Scale Riff (M1-2) - 8th notes
                '1','-','3','-','5','-','-','-','5','-','3','-','1','-','-','-', // M1
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M2
                // C Arpeggio (Pos 1) (M3-4) - 8th notes
                '1','-','-','-','5','-','-','-','8','-','-','-','5','-','-','-', // M3
                '1','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M4
                // F Arpeggio (Pos 1) (M5-6) - 8th notes
                '-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M5
                '1','-','-','-','6','-','-','-','10','-','-','-','6','-','-','-', // M6
                // G Arpeggio (Pos 1) (M7-8) - 8th notes
                '3','-','-','-','8','-','-','-','12','-','-','-','8','-','-','-', // M7
                '3','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-', // M8
            ],
        };
        const C_MAJOR_GUITAR_7_STRING_TAB = {
            'e4': [...C_MAJOR_BASE_TAB['e4']], // Reuse 6-string part
            'B3': [...C_MAJOR_BASE_TAB['B3']], // Reuse 6-string part
            'G3': [...C_MAJOR_BASE_TAB['G3']], // Reuse 6-string part
            'D3': [...C_MAJOR_BASE_TAB['D3']], // Reuse 6-string part
            'A2': [...C_MAJOR_BASE_TAB['A2']], // Reuse 6-string part
            'E2': [...C_MAJOR_BASE_TAB['E2']], // Reuse 6-string part
            'B1': [ // New 32-measure part (8-measure loop repeated 4x)
                ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'], ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'],
                ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1'], ...C_MAJOR_GUITAR_7_STRING_8_MEASURE_LOOP['B1']
            ],
        };
        // --- UPDATED: Note map for new 7-string part ---
        const C_MAJOR_GUITAR_7_STRING_NOTE_MAP = {
            ...C_MAJOR_BASE_NOTE_MAP, // Inherit all 6-string maps
            'B1': { '1': 12, '3': 14, '5': 16, '6': 17, '8': 19, '10': 21, '12': 23 } // Add B1 frets
        };
        // --- END 7-STRING GUITAR CONSTANTS ---


        // --- CORE LOGIC FUNCTIONS ---

        function getNoteName(startNoteIndex, startOctave, fret) {
            const totalHalfSteps = startNoteIndex + fret;
            const noteIndex = totalHalfSteps % 12;
            const octave = startOctave + Math.floor(totalHalfSteps / 12); 

            const noteData = CHROMATIC_NOTES[noteIndex];
            const primaryName = noteData.name;
            const displayNote = noteData.aliases.length > 0 ? `${primaryName}/${noteData.aliases[0]}` : primaryName;

            return {
                full: `${displayNote}${octave}(${fret})`,
                name_only: displayNote,
                index: noteIndex,
                octave: octave
            };
        }

        function isNoteInScale(noteIndex, rootIndex, scaleIntervals) {
            const relativeIndex = (noteIndex - rootIndex + 12) % 12;
            return scaleIntervals.includes(relativeIndex);
        }

        function getOrdinal(n) {
            if (10 <= n % 100 && n % 100 <= 20) return `${n}th`;
            return { 1: `${n}st`, 2: `${n}nd`, 3: `${n}rd` }[n % 10] || `${n}th`;
        }
        
        function getRootOptions() {
            return CHROMATIC_NOTES.reduce((acc, note, index) => {
                const name = note.name + (note.aliases.length > 0 ? `/${note.aliases[0]}` : '');
                acc[name] = index;
                return acc;
            }, {});
        }

        function buildInstrumentData(instrumentKey, rootIndex, scaleIntervals) {
            const tuning = TUNINGS[instrumentKey];
            const fretboardData = [];
            
            // Determine number of frets to display
            let fretCount = NUM_FRETS; // Use global
            if (instrumentKey.includes('Banjo')) {
                fretCount = 10;
            } else if (instrumentKey.includes('Mandolin')) {
                fretCount = 12;
            }

            for (const stringInfo of tuning) {
                const row = {
                    stringName: stringInfo.label, // 'e', 'B', 'G', 'D', 'A', 'E'
                    open_note_full: `${stringInfo.open_note}(0)`,
                    open_note_name: stringInfo.open_note,
                    label: stringInfo.label,
                    ordinal: getOrdinal(stringInfo.string),
                    cells: [],
                    thickness: stringInfo.thickness,
                    string_index: stringInfo.string,
                    base_note_index: stringInfo.note_index // Store base index for transposition
                };

                for (let fret = 0; fret <= fretCount; fret++) {
                    let noteValue = '---';
                    let isRoot = false;
                    let noteName = '';
                    
                    // Banjo 5th string (drone string) typically ends at fret 5
                    const isDroneString = instrumentKey.includes('Banjo') && stringInfo.string === 5;
                    if (isDroneString && fret > 5) {
                        row.cells.push({ fret, value: noteValue, is_root: false, name: '', is_scale: false, note_index: -1 });
                        continue;
                    }

                    const note = getNoteName(stringInfo.note_index, stringInfo.octave, fret);
                    let isScale = false;

                    if (isNoteInScale(note.index, rootIndex, scaleIntervals)) {
                        noteValue = note.full;
                        noteName = note.name_only;
                        isScale = true;
                        if (note.index === rootIndex) {
                            isRoot = true;
                        }
                    }

                    row.cells.push({
                        fret,
                        value: noteValue,
                        is_root: isRoot,
                        is_scale: isScale,
                        name: noteName,
                        note_index: note.index
                    });
                }
                fretboardData.push(row);
            }
            // Data is [Thin (idx 0) ... Thick (idx N-1)]
            return fretboardData;
        }

        // --- RENDERING FUNCTIONS (GUI and Tables) ---

        function renderGui(fretboardData, instrumentKey, handedness, showNotes) {
            const numStrings = fretboardData.length;
            const fretCount = fretboardData[0].cells.length - 1;

            const fretboardGui = document.createElement('div');
            fretboardGui.className = 'fretboard-gui';
            fretboardGui.style.height = `${numStrings * STRING_PITCH_GAP + 50}px`; 

            // Calculate GUI width
            const guiWidth = fretCount * FRET_SPACING + FRET_SPACING; // Max frets * spacing + 1 additional space for Fret 0
            fretboardGui.style.minWidth = `${guiWidth}px`;

            // Draw Frets (Vertical Lines)
            for (let f = 0; f <= fretCount; f++) {
                const fretPos = f * FRET_SPACING;
                const fretEl = document.createElement('div');
                fretEl.className = 'fret';
                fretEl.style.left = `${fretPos}px`;
                fretEl.style.width = '1px';
                
                if (f > 0) {
                    fretEl.style.transform = 'translateX(-1px)';
                } else {
                    fretEl.style.borderLeft = '6px solid #aaa'; // Nut (Fret 0 marker)
                    fretEl.style.left = '0';
                    fretEl.style.zIndex = '50';
                }
                fretboardGui.appendChild(fretEl);

                // Fret Markers (Dots)
                const midPointY = (30 + (numStrings - 1) * STRING_PITCH_GAP + 30) / 2; // Midpoint between first and last string
                if ([3, 5, 7, 9, 15].includes(f) && f <= fretCount) {
                    const marker = document.createElement('div');
                    marker.className = 'fret-marker';
                    marker.style.left = `${fretPos + (FRET_SPACING / 2)}px`; 
                    marker.style.top = `${midPointY}px`;
                    fretboardGui.appendChild(marker);
                }
                if (f === 12 && f <= fretCount) {
                    const marker1 = document.createElement('div');
                    marker1.className = 'fret-marker';
                    marker1.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
                    marker1.style.top = `${midPointY - STRING_PITCH_GAP}px`;
                    fretboardGui.appendChild(marker1);

                    const marker2 = document.createElement('div');
                    marker2.className = 'fret-marker';
                    marker2.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
                    marker2.style.top = `${midPointY + STRING_PITCH_GAP}px`;
                    fretboardGui.appendChild(marker2);
                }

                // Fret Number Label
                const numLabel = document.createElement('div');
                numLabel.className = 'fret-number';
                
                if (f === 0) {
                    numLabel.textContent = '0';
                    numLabel.style.left = `${FRET_SPACING / 2}px`; 
                    fretboardGui.appendChild(numLabel);
                } else if (f <= fretCount) {
                    numLabel.textContent = f;
                    numLabel.style.left = `${fretPos + (FRET_SPACING / 2)}px`;
                    fretboardGui.appendChild(numLabel);
                }
            }
            
            // Draw Strings and Notes
            
            // Determine string order for rendering
            let orderedStrings = [...fretboardData];
            if (handedness === 'right') {
                // RIGHT-HANDED: Player View (Thinnest string on top, Thickest string on bottom)
                orderedStrings.sort((a, b) => a.thickness - b.thickness);
            } else {
                // LEFT-HANDED: Mirrored View (Thickest string on top, Thinnest string on bottom)
                orderedStrings.sort((a, b) => b.thickness - a.thickness);
            }

            // Find the maximum thickness to normalize string heights
            const maxThickness = orderedStrings.reduce((max, s) => Math.max(max, s.thickness), 0);
            
            orderedStrings.forEach((stringData, stringIndex) => {
                // String vertical position
                const stringY = 30 + stringIndex * STRING_PITCH_GAP; 

                // String wire
                const stringEl = document.createElement('div');
                stringEl.className = 'string';
                stringEl.style.top = `${stringY}px`;
                
                const lineHeight = 1 + (stringData.thickness / maxThickness) * 2; 
                stringEl.style.height = `${lineHeight}px`; 
                
                fretboardGui.appendChild(stringEl);

                // String label (open note name)
                const labelEl = document.createElement('div');
                labelEl.className = 'string-label';
                labelEl.textContent = stringData.open_note_name;
                labelEl.style.top = `${stringY}px`;
                fretboardGui.appendChild(labelEl);

                // Place notes (dots)
                stringData.cells.forEach(cell => {
                    if (cell.is_scale && cell.fret >= 0) {
                        const dotEl = document.createElement('div');
                        dotEl.className = `fret-dot ${cell.is_root ? 'root' : 'scale'}`;
                        
                        // Use showNotes to determine content
                        const dotContent = showNotes ? cell.name.split('/')[0] : (cell.is_root ? 'R' : '');
                        dotEl.textContent = dotContent;

                        let xPos;
                        const dotSize = 24; // 1.5rem

                        if (cell.fret === 0) {
                             xPos = (FRET_SPACING / 2);
                        } else {
                            xPos = (cell.fret * FRET_SPACING) + (FRET_SPACING / 2);
                        }

                        dotEl.style.left = `${xPos}px`;
                        dotEl.style.top = `${stringY}px`;
                        
                        const isDroneString = instrumentKey.includes('Banjo') && stringData.string_index === 5;
                        if (isDroneString && cell.fret > 5) return;

                        fretboardGui.appendChild(dotEl);
                    }
                });
            });

            const guiWrapper = document.createElement('div');
            guiWrapper.className = 'fretboard-container';
            guiWrapper.appendChild(fretboardGui);
            
            return guiWrapper;
        }

        function renderTable1(fretboardData, rootName, modeName, showNotes) {
            // Orientation 1: Strings as Rows (Thin to Thick, top to bottom)
            const fretCount = fretboardData[0].cells.length - 1;

            // Sort data: Thin (top row) to Thick (bottom row)
            let orderedStrings = [...fretboardData].sort((a, b) => a.thickness - b.thickness);

            let html = `<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Strings as Rows (Thinnest String at Top)</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">String</th>
                                ${Array.from({ length: fretCount + 1 }, (_, i) => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Fret ${i}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${orderedStrings.map(stringData => {
                                const stringLabel = `${stringData.label} (${stringData.open_note_name})`;
                                return `<tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stringLabel}</td>
                                    ${stringData.cells.map(note => {
                                        const isRoot = note.is_root;
                                        const isScale = note.is_scale && !isRoot;
                                        let classes = 'px-2 py-4 whitespace-nowrap text-center text-sm font-bold';
                                        if (isRoot) {
                                            classes += ' bg-red-100 text-red-800 rounded-lg';
                                        } else if (isScale) {
                                            classes += ' bg-indigo-100 text-indigo-800 rounded-lg';
                                        } else {
                                            classes += ' text-gray-400';
                                        }
                                        const display = showNotes ? (note.is_scale ? note.name : '-') : (note.is_scale ? (isRoot ? 'R' : 'X') : '-');
                                        return `<td class="${classes}">${display}</td>`;
                                    }).join('')}
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
            return html;
        }

        function renderTable2(fretboardData, rootName, modeName, handedness, showNotes) {
            // Orientation 2: Frets as Rows (Transposed - Handedness Specific)
            const fretCount = fretboardData[0].cells.length - 1;

            // Determine column order based on handedness
            let stringsToRender = [...fretboardData];
            if (handedness === 'right') {
                // Right-Handed: Thickest (Left) to Thinnest (Right)
                stringsToRender.sort((a, b) => b.thickness - a.thickness);
            } else {
                // Left-Handed: Thinnest (Left) to Thickest (Right)
                stringsToRender.sort((a, b) => a.thickness - b.thickness);
            }

            // Headers (Strings)
            const stringHeaders = stringsToRender.map(s => `${s.label} (${s.open_note_name})`);
            
            let html = `<div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Frets as Rows (Fretboard Map)</h3>
                <p class="text-sm text-gray-500 mb-4">String order reflects the player's perspective (${handedness}-handed).</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fret</th>
                                ${stringHeaders.map(label => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${Array.from({ length: fretCount + 1 }, (_, f) => {
                                return `<tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Fret ${f}</td>
                                    ${stringsToRender.map(stringData => {
                                        const note = stringData.cells[f];
                                        const isRoot = note.is_root;
                                        const isScale = note.is_scale && !isRoot;
                                        let classes = 'px-2 py-4 whitespace-nowrap text-center text-sm font-bold';
                                        if (isRoot) {
                                            classes += ' bg-red-100 text-red-800 rounded-lg';
                                        } else if (isScale) {
                                            classes += ' bg-indigo-100 text-indigo-800 rounded-lg';
                                        } else {
                                            classes += ' text-gray-400';
                                        }
                                        const display = showNotes ? (note.is_scale ? note.name : '-') : (note.is_scale ? (isRoot ? 'R' : 'X') : '-');
                                        return `<td class="${classes}">${display}</td>`;
                                    }).join('')}
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
            return html;
        }

        // --- NEW: TABLATURE PLAYBACK LOGIC (Part VII) ---

        /**
         * Parses the transposed tab data into an array of events for Tone.js.
         * @param {object} transposedTab - The tab object, e.g., { e4: ['0', '1', '-'], ... }
         * @param {object} stringDataMap - Map of string data for note calculation.
         * @param {number} tempo - The BPM for playback.
         * @returns {Array} An array of playable events for Tone.Part.
         */
        function parseTabToPlayableEvents(transposedTab, stringDataMap, tempo) {
            const playableEvents = [];
            const timePerBeat = 60 / tempo / 4; // Time for one 16th note
            const noteDuration = "16n";

            const stringNames = Object.keys(transposedTab);
            if (stringNames.length === 0) return [];

            const totalNotes = transposedTab[stringNames[0]].length;

            for (let i = 0; i < totalNotes; i++) { // Iterate through each time step (16th note)
                for (const stringFullName of stringNames) { // e.g., 'e4', 'B3'
                    const fret = transposedTab[stringFullName][i];

                    // Check for a playable note
                    if (fret !== '-' && fret !== '?' && fret !== undefined) {
                        const stringData = stringDataMap[stringFullName];
                        if (!stringData) continue;

                        // a. Calculate time
                        const time = i * timePerBeat;

                        // b. Calculate note name using Tonal.js
                        const baseMidi = Tonal.Note.midi(stringData.open_note_name);
                        if (baseMidi === undefined) continue;

                        const noteMidi = baseMidi + parseInt(fret, 10);
                        const noteName = Tonal.Note.fromMidi(noteMidi);

                        // c. Add the event object
                        playableEvents.push({
                            time: time,
                            note: noteName,
                            duration: noteDuration
                        });
                    }
                }
            }
            return playableEvents;
        }

        /**
         * Plays the parsed tablature using Tone.js.
         * @param {Array} playableEvents - The array of note objects from the parser.
         */
        async function playTablature(playableEvents) {
            if (playableEvents.length === 0) {
                console.log("No notes to play.");
                return;
            }

            await Tone.start(); // Ensure AudioContext is running
            stopTablature(); // Stop any previous playback

            currentTabPart = new Tone.Part((time, event) => {
                synth.triggerAttackRelease(event.note, event.duration, time);
            }, playableEvents).start(0);

            Tone.Transport.start();
        }

        /**
         * Stops the tablature playback.
         */
        function stopTablature() {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            if (currentTabPart) {
                currentTabPart.dispose();
                currentTabPart = null;
            }
        }


        // --- KEY & HARMONY SECTION LOGIC ---

        const CIRCLE_OF_FIFTHS_ORDER = ["C", "G", "D", "A", "E", "B", "F#", "Db", "Ab", "Eb", "Bb", "F"];

        function initializeKeyHarmonySection() {
            const circleContainer = document.querySelector('.circle-of-fifths');
            const radius = circleContainer.offsetWidth / 2 - 35; // 35 is half button width + margin

            CIRCLE_OF_FIFTHS_ORDER.forEach((key, i) => {
                const angle = (i / CIRCLE_OF_FIFTHS_ORDER.length) * 2 * Math.PI - (Math.PI / 2);
                const x = radius * Math.cos(angle) + radius;
                const y = radius * Math.sin(angle) + radius;

                const keyBtn = document.createElement('button');
                keyBtn.className = 'key-button';
                keyBtn.textContent = key;
                keyBtn.style.left = `${x}px`;
                keyBtn.style.top = `${y}px`;
                keyBtn.dataset.key = key;

                keyBtn.addEventListener('click', () => handleKeySelection(key));
                circleContainer.appendChild(keyBtn);
            });

            // Set initial active key
            handleKeySelection('C');
        }

        function handleKeySelection(key) {
            // Update active button on circle
            document.querySelectorAll('.key-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.key === key);
            });

            // Get diatonic chords using Tonal.js
            const scaleChords = Tonal.Scale.chords(`${key} major`);
            
            // Update diatonic chord display
            const diatonicChordsDisplay = document.getElementById('diatonic-chords-display');
            diatonicChordsDisplay.innerHTML = '';
            scaleChords.forEach(chord => {
                const chordBtn = document.createElement('button');
                chordBtn.className = 'diatonic-chord-btn bg-white hover:bg-indigo-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm';
                chordBtn.textContent = chord;
                chordBtn.dataset.chord = chord;
                chordBtn.addEventListener('click', () => handleChordSelection(chord, key));
                diatonicChordsDisplay.appendChild(chordBtn);
            });

            // Update common progressions display
            displayProgressions(key);

            // Clear chord diagram
            document.getElementById('chord-display-container').innerHTML = `<p class="text-gray-500 italic">Select a chord to display its diagram.</p>`;
        }

        function handleChordSelection(chord, key) {
             // Update active button for chords
            document.querySelectorAll('.diatonic-chord-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.chord === chord);
            });

            const instrumentKey = document.getElementById('instrumentFilter').value;
            
            if (!chordShapes[instrumentKey] || !chordShapes[instrumentKey][chord]) {
                document.getElementById('chord-display-container').innerHTML = `<p class="text-orange-500">No diagram available for ${chord} on this instrument.</p>`;
                return;
            }

            const voicing = chordShapes[instrumentKey][chord][0]; // Default to first voicing
            renderChordDiagram(voicing, '#chord-display-container');
        }

        function renderChordDiagram(chordData, targetDivId) {
            const targetElement = document.querySelector(targetDivId);
            if (!targetElement) {
                console.error("SVGuitar Target Element not found:", targetDivId);
                return;
            }
            targetElement.innerHTML = ""; // Clear previous diagram

            try {
                const chart = new SVGuitarChord(targetDivId);
                chart.chord({
                    frets: chordData.frets,
                    fingers: chordData.fingers,
                    barres: chordData.barres || [],
                    title: chordData.title
                }).draw();
            } catch (error) {
                console.error("Error rendering SVGuitar chart:", error);
                targetElement.innerHTML = `<p class="text-red-500">Error rendering chord diagram.</p>`;
            }
        }

        function displayProgressions(keyName) {
            const displayUI = document.getElementById('chord-progression-display');
            displayUI.innerHTML = ""; // Clear old progressions

            const progressions = {
                major: [
                    { name: "Axis Progression", formula: "I-V-vi-IV" },
                    { name: "Doo-Wop", formula: "I-vi-IV-V" },
                    { name: "Jazz (ii-V-I)", formula: "ii-V-I" },
                    { name: "Minor Feel", formula: "vi-IV-I-V" }
                ]
            };

            const romanNumerals = Tonal.RomanNumeral.fromContext(keyName);
            
            let html = `<h4 class="font-bold text-gray-700 mb-2">Common Progressions in ${keyName} Major:</h4>`;
            progressions.major.forEach(prog => {
                const numerals = prog.formula.split("-");
                const chordNames = numerals.map(n => romanNumerals(n)).join(" - ");
                html += `<div class="text-sm"><span class="font-semibold">${prog.name} (${prog.formula}):</span> ${chordNames}</div>`;
            });
            displayUI.innerHTML = html;
        }


        function generateFretboards() {
            try {
                const rootSelect = document.getElementById('rootSelect');
                const modeSelect = document.getElementById('modeSelect');
                const instrumentSelect = document.getElementById('instrumentFilter');
                const orientationSelect = document.querySelector('input[name="orientation"]:checked');
                const handednessSelect = document.getElementById('handedness');
                const showNotesCheck = document.getElementById('show-notes');
                const outputDiv = document.getElementById('fretboard-output');
                const rootOptions = getRootOptions();

                const instrumentKey = instrumentSelect.value;
                const rootName = rootSelect.value;
                const scaleName = modeSelect.value;
                const orientation = orientationSelect.value;
                const handedness = handednessSelect.value;
                const showNotes = showNotesCheck.checked;

                // Simple validation check (should always pass after initialization)
                if (!rootName || !scaleName || !instrumentKey) {
                    outputDiv.innerHTML = `<p class="text-center text-red-500 italic p-6 border rounded-lg bg-red-100">
                        Please select a Root Note and a Scale/Mode above to generate the fretboard charts.
                    </p>`;
                    return;
                }

                const rootIndex = rootOptions[rootName];
                
                // Get the Tonal.js scale name from our SCALES object
                let tonalScaleName = '';
                for (const category in SCALES) {
                    if (SCALES[category][scaleName]) {
                        tonalScaleName = SCALES[category][scaleName];
                        break;
                    }
                }

                if (!tonalScaleName) {
                    throw new Error(`Scale "${scaleName}" not found in the database.`);
                }

                const scaleIntervals = Tonal.Scale.get(`${rootName} ${tonalScaleName}`).intervals.map(Tonal.Interval.semitones);


                // Data is [Thin (idx 0) ... Thick (idx N-1)]
                const fretboardData = buildInstrumentData(instrumentKey, rootIndex, scaleIntervals);

                let htmlOutput = `<h2 class="text-3xl font-bold text-indigo-700 mb-6">${instrumentKey} Fretboard: ${rootName} ${scaleName}</h2>`;

                // Add fundamentals accordion for fretboard diagrams
                htmlOutput += `<div class="mb-6 accordion-container">
                    <div class="accordion-header">
                        <span>[+] What is a Fretboard Diagram?</span>
                        <span class="accordion-symbol">+</span>
                    </div>
                    <div class="accordion-content">
                        <p class="text-gray-700 text-sm">These diagrams visualize the notes of the selected scale on the instrument's neck. The <strong>red dots (R)</strong> are the "Root" notes of the scale. The <strong>blue dots</strong> are the other notes in the scale. You can toggle between showing note names (C, D, E) or symbols (R, X) using the "Show Note Names" checkbox.</p>
                    </div>
                </div>`;


                // 1. Render GUI Visualization (pass showNotes)
                htmlOutput += renderGui(fretboardData, instrumentKey, handedness, showNotes).outerHTML;

                // 2. Render Tables
                htmlOutput += '<div class="chart-output space-y-8">';
                
                if (orientation === 'both' || orientation === '1') {
                    // Orientation 1 (Strings as Rows) (pass showNotes)
                    htmlOutput += renderTable1(fretboardData, rootName, scaleName, showNotes);
                }
                if (orientation === 'both' || orientation === '2') {
                    // Orientation 2 (Frets as Rows) (pass showNotes)
                    htmlOutput += renderTable2(fretboardData, rootName, scaleName, handedness, showNotes);
                }

                // 3. Render Tablature (Now receives fretboardData)
                // --- MODIFIED: Call the correct renderer based on instrument key ---
                if (instrumentKey.includes('6-String Guitar')) {
                    htmlOutput += renderGuitarTab(fretboardData, rootIndex, scaleIntervals, rootName, scaleName);
                } else if (instrumentKey.includes('4-String Bass')) {
                    htmlOutput += renderBassTab(fretboardData, rootIndex, scaleIntervals, rootName, scaleName);
                } else if (instrumentKey.includes('Mandolin')) {
                    htmlOutput += renderMandolinTab(fretboardData, rootIndex, scaleIntervals, rootName, scaleName);
                } else if (instrumentKey.includes('5-String Bass')) {
                    htmlOutput += renderBass5StringTab(fretboardData, rootIndex, scaleIntervals, rootName, scaleName);
                } else if (instrumentKey.includes('7-String Guitar')) {
                    htmlOutput += renderGuitar7StringTab(fretboardData, rootIndex, scaleIntervals, rootName, scaleName);
                } else if (instrumentKey.includes('5-String Banjo')) {
                    htmlOutput += renderBanjoTab(fretboardData, rootIndex, scaleIntervals, rootName, scaleName);
                } else {
                    // Display a "not available" message for other instruments
                    htmlOutput += `<div class="p-6 bg-white rounded-xl shadow-xl mt-10 border-t-8 border-indigo-700">
                        <h3 class="text-2xl font-bold mb-4 text-indigo-700">Tablature Training Template</h3>
                        <p class="text-gray-600 mb-6 italic">This feature is not yet available for the selected instrument.</p>
                    </div>`;
                }
                // --- END MODIFICATION ---

                htmlOutput += '</div>';


                outputDiv.innerHTML = htmlOutput;
            } catch (error) {
                console.error("Error during generation:", error);
                const outputDiv = document.getElementById('fretboard-output');
                outputDiv.innerHTML = `<p class="text-center text-red-700 font-bold p-6 border rounded-lg bg-red-100">
                    A critical error occurred: ${error.message}. Please check the console for details.
                </p>`;
            }
        }

        window.onload = async () => {
            await loadChordShapes(); // Load chord data first
            initializeControls(); // Setup controls and run initial generation
            initializeKeyHarmonySection(); // Setup the interactive harmony section
            initializeAccordions(); // Initialize all accordion elements
        };

    </script>
</body>
</html>